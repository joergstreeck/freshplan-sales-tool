name: Handover Validation
# Validiert Handover-Dokumente bei jedem Push
# Erstellt: 2025-10-18
# Stellt sicher, dass Ãœbergaben vollstÃ¤ndig und korrekt sind

on:
  push:
    branches: ['**']
    paths:
      - 'docs/planung/claude-work/**/*.md'
      - 'scripts/create-handover*.sh'
  pull_request:
    branches: ['**']
    paths:
      - 'docs/planung/claude-work/**/*.md'
      - 'scripts/create-handover*.sh'

jobs:
  validate-handovers:
    name: Validate Handover Documents
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Volle History fÃ¼r Vergleiche

      - name: Check Handover Structure
        run: |
          echo "ğŸ” PrÃ¼fe Handover-Dokumente..."

          # Finde alle Handover-Dateien (nur Added/Modified, NICHT Deleted)
          HANDOVER_FILES=$(git diff --diff-filter=AM --name-only HEAD~1 HEAD 2>/dev/null | grep "docs/planung/claude-work.*HANDOVER.*\.md" || echo "")

          if [ -z "$HANDOVER_FILES" ]; then
            echo "â„¹ï¸  Keine neuen Handover-Dokumente"
            exit 0
          fi

          echo "ğŸ“„ Gefundene Handover-Dokumente:"
          echo "$HANDOVER_FILES"
          echo ""

          ERROR=0

          for FILE in $HANDOVER_FILES; do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ” Validiere: $(basename $FILE)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            if [ ! -f "$FILE" ]; then
              echo "âŒ Datei nicht gefunden: $FILE"
              ERROR=1
              continue
            fi

            # PrÃ¼fe Required Sections
            REQUIRED_SECTIONS=(
              "WAS WURDE GEMACHT"
              "BEKANNTE PROBLEME"
              "NÃ„CHSTER SCHRITT"
              "TODO-STATUS"
              "TECHNISCHE DETAILS"
            )

            MISSING=0
            for SECTION in "${REQUIRED_SECTIONS[@]}"; do
              if ! grep -qi "$SECTION" "$FILE"; then
                echo "âŒ Fehlende Section: $SECTION"
                MISSING=1
              else
                echo "âœ… Section vorhanden: $SECTION"
              fi
            done

            if [ $MISSING -eq 1 ]; then
              ERROR=1
              echo ""
              echo "âŒ FEHLER: Handover unvollstÃ¤ndig!"
              echo "   Datei: $FILE"
              echo "   Nutze: scripts/create-handover.sh"
              continue
            fi

            # PrÃ¼fe auf MANUAL-Platzhalter (darf nicht committed werden)
            if grep -q "\[MANUAL:" "$FILE"; then
              echo "âŒ FEHLER: Handover enthÃ¤lt MANUAL-Platzhalter!"
              echo "   Handover muss vollstÃ¤ndig ausgefÃ¼llt werden!"
              ERROR=1
              continue
            fi

            # PrÃ¼fe auf PENDING-Marker
            if grep -qi "MP5-Status.*PENDING" "$FILE"; then
              echo "âš ï¸  WARNUNG: MP5-Status ist PENDING"
              echo "   MP5 QUICK UPDATE sollte vor Commit durchgefÃ¼hrt werden"
              # Kein Error, nur Warnung
            fi

            # PrÃ¼fe Migration-Referenz
            if ! grep -qiE "(Migration:|V[0-9]+|n/a)" "$FILE"; then
              echo "âš ï¸  WARNUNG: Keine Migration-Referenz gefunden"
              # Kein Error, nur Warnung
            fi

            echo ""
            echo "âœ… Handover-Struktur validiert!"
            echo ""
          done

          if [ $ERROR -eq 1 ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ Handover Validation FEHLGESCHLAGEN!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Alle Handover-Dokumente validiert!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Check Handover Script
        run: |
          echo "ğŸ” PrÃ¼fe Handover-Scripts..."

          SCRIPT_FILES=$(git diff --diff-filter=AM --name-only HEAD~1 HEAD 2>/dev/null | grep "scripts/create-handover.*\.sh" || echo "")

          if [ -z "$SCRIPT_FILES" ]; then
            echo "â„¹ï¸  Keine Script-Ã„nderungen"
            exit 0
          fi

          for SCRIPT in $SCRIPT_FILES; do
            echo "ğŸ” PrÃ¼fe Script: $(basename $SCRIPT)"

            if [ ! -f "$SCRIPT" ]; then
              echo "âŒ Script nicht gefunden: $SCRIPT"
              exit 1
            fi

            if [ ! -x "$SCRIPT" ]; then
              echo "âŒ Script nicht ausfÃ¼hrbar: $SCRIPT"
              echo "   Fix: chmod +x $SCRIPT"
              exit 1
            fi

            # PrÃ¼fe auf kritische Funktionen
            if ! grep -q "find_project_root\|PROJECT_ROOT" "$SCRIPT"; then
              echo "âš ï¸  WARNUNG: Script fehlt project-root Erkennung"
            fi

            if ! grep -q "migration\|Migration\|MIGRATION" "$SCRIPT"; then
              echo "âš ï¸  WARNUNG: Script fehlt Migration-Handling"
            fi

            echo "âœ… Script-PrÃ¼fung OK"
          done

      - name: Check Daily Work Structure
        run: |
          echo "ğŸ” PrÃ¼fe daily-work Ordner-Struktur..."

          # PrÃ¼fe ob Ordner-Struktur existiert
          if [ ! -d "docs/planung/claude-work/daily-work" ]; then
            echo "âŒ Ordner nicht gefunden: docs/planung/claude-work/daily-work"
            exit 1
          fi

          # PrÃ¼fe auf korrekte Datum-Ordner (YYYY-MM-DD)
          INVALID_FOLDERS=$(find docs/planung/claude-work/daily-work -mindepth 1 -maxdepth 1 -type d | \
            grep -v "/[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}$" || echo "")

          if [ ! -z "$INVALID_FOLDERS" ]; then
            echo "âŒ FEHLER: UngÃ¼ltige Ordner-Namen gefunden!"
            echo "$INVALID_FOLDERS"
            echo ""
            echo "Korrekt: YYYY-MM-DD (z.B. 2025-10-18)"
            exit 1
          fi

          echo "âœ… Ordner-Struktur korrekt!"

      - name: Summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Handover Validation BESTANDEN!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Alle PrÃ¼fungen erfolgreich:"
          echo "  âœ… Handover-Struktur vollstÃ¤ndig"
          echo "  âœ… Keine MANUAL-Platzhalter"
          echo "  âœ… Scripts ausfÃ¼hrbar"
          echo "  âœ… Ordner-Struktur korrekt"
