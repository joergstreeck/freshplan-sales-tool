name: Mock Guard - Business Logic Protection

on:
  pull_request:
    paths:
      - 'frontend/src/**/*.ts'
      - 'frontend/src/**/*.tsx'
      - 'backend/src/main/java/**/*.java'
      - '.github/workflows/mock-guard.yml'  # Test workflow changes

jobs:
  mock-guard:
    name: Check for Mock Data in Business Logic
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed business files
        id: changed
        uses: tj-actions/changed-files@v45
        with:
          files: |
            frontend/src/app/**/*
            frontend/src/features/**/*
            frontend/src/lib/**/*
            frontend/src/hooks/**/*
            frontend/src/store/**/*
            backend/src/main/java/de/freshplan/modules/**/domain/**/*
            backend/src/main/java/de/freshplan/modules/**/application/**/*

      - name: Check for mock data in changed files
        if: steps.changed.outputs.any_changed == 'true'
        run: |
          set -euo pipefail

          echo "🔍 Checking for mock data in business logic files..."
          files="${{ steps.changed.outputs.all_changed_files }}"

          if [ -z "$files" ]; then
            echo "✅ No business logic files changed"
            exit 0
          fi

          # Check for mock patterns
          violations=""
          for file in $files; do
            # Skip test files
            if [[ "$file" == *".test."* ]] || [[ "$file" == *".spec."* ]] || [[ "$file" == *".stories."* ]]; then
              continue
            fi

            # Search for mock patterns
            if grep -E "(import|from).*mock|mockData|__mocks__|/mocks?/|TestDataBuilder" "$file" 2>/dev/null; then
              violations="$violations\n❌ $file contains mock data"
            fi
          done

          if [ -n "$violations" ]; then
            echo -e "❌ Mock data found in business logic:\n$violations"
            echo ""
            echo "📚 Mock-Governance Policy:"
            echo "- Business logic must be mock-free"
            echo "- Use dev-seeds for development data"
            echo "- Mocks are only allowed in test files"
            echo ""
            echo "🔗 See: docs/planung/features-neu/00_infrastruktur/standards/03_MOCK_GOVERNANCE.md"
            exit 1
          fi

          echo "✅ No mock data found in business logic files"

      - name: Comment on PR
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ❌ Mock Guard Failed

              Mock data was detected in business logic files.

              **Mock-Governance Policy:**
              - Business logic paths must be mock-free
              - Use \`db/dev-migration\` for development data
              - Mocks are only allowed in test files

              Please remove mock imports from business logic and use proper dev-seeds instead.

              📚 [Mock Governance Documentation](docs/planung/features-neu/00_infrastruktur/standards/03_MOCK_GOVERNANCE.md)`
            })