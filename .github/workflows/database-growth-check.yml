name: Database Growth Check

on:
  push:
    branches: [ main, develop, feature/*, feat/* ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: db-growth-${{ github.ref }}
  cancel-in-progress: true


jobs:
  check-database-growth:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: freshplan
          POSTGRES_PASSWORD: freshplan
          POSTGRES_DB: freshplan  # Changed from postgres to freshplan
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U freshplan -d freshplan"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-m2-${{ hashFiles('backend/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2-

    - name: Install PostgreSQL client
      run: sudo apt-get update && sudo apt-get install -y postgresql-client

    - name: Reset DB schema for clean state
      env:
        PGPASSWORD: freshplan
      run: |
        echo "Resetting database schema to clean state..."
        psql -h localhost -U freshplan -d freshplan -v ON_ERROR_STOP=1 -c "DROP SCHEMA IF EXISTS public CASCADE; CREATE SCHEMA public;"
        psql -h localhost -U freshplan -d freshplan -v ON_ERROR_STOP=1 -c "CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";"
        psql -h localhost -U freshplan -d freshplan -v ON_ERROR_STOP=1 -c "CREATE EXTENSION IF NOT EXISTS pgcrypto;"
        echo "Database schema reset successfully"

    - name: Initialize database with Flyway
      working-directory: backend
      env:
        QUARKUS_PROFILE: ci
        MAVEN_OPTS: -Xmx2g -XX:MaxMetaspaceSize=512m
      run: |
        echo "Initializing database schema with Flyway..."

        # Run Flyway migration only (no tests needed for growth check)
        ./mvnw flyway:migrate \
          -B \
          -Dflyway.url="jdbc:postgresql://localhost:5432/freshplan" \
          -Dflyway.user=freshplan \
          -Dflyway.password=freshplan \
          -Dflyway.locations=filesystem:src/main/resources/db/migration

        echo "✅ Database initialized"
    
    - name: Verify test cleanup
      env:
        PGPASSWORD: freshplan
      run: |
        # After tests, verify database is properly cleaned
        # With clean-at-start=true, each test run should start fresh
        CUSTOMER_COUNT=$(psql -h localhost -U freshplan -d freshplan -tAc "SELECT COUNT(*) FROM customers;" 2>/dev/null || echo "0")
        echo "Customers after tests: $CUSTOMER_COUNT"

        # Check if test data was properly cleaned
        TEST_DATA_COUNT=$(psql -h localhost -U freshplan -d freshplan -tAc "SELECT COUNT(*) FROM customers WHERE is_test_data = true;" 2>/dev/null || echo "0")
        echo "Test customers remaining: $TEST_DATA_COUNT"

        echo "✅ Test cleanup verification complete"

    - name: Check for test isolation issues
      if: always()
      working-directory: backend
      run: |
        echo "Checking for common test isolation problems..."
        
        # Look for tests without @TestTransaction
        echo "Tests that might be missing @TestTransaction:"
        grep -r "@Test" src/test --include="*.java" | \
          grep -v "@TestTransaction" | \
          grep -E "(create|save|persist|insert|update|delete)" | \
          head -20 || echo "No obvious issues found"
        
        echo ""
        echo "Remember:"
        echo "- Use @TestTransaction for database tests"
        echo "- Each test should be self-contained"
        echo "- Don't rely on data from other tests"

    - name: Upload test reports
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports-${{ github.run_number }}
        path: |
          backend/target/surefire-reports/**
          backend/target/failsafe-reports/**