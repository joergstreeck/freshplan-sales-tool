name: Database Growth Check

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: db-growth-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-database-growth:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: freshplan
          POSTGRES_PASSWORD: freshplan
          POSTGRES_DB: freshplan
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U freshplan -d freshplan"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-m2-${{ hashFiles('backend/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2-

    - name: Install PostgreSQL client
      run: sudo apt-get update && sudo apt-get install -y postgresql-client
    
    - name: Reset DB schema for clean state
      env:
        PGPASSWORD: freshplan
      run: |
        psql -h localhost -U freshplan -d freshplan -v ON_ERROR_STOP=1 -c "DROP SCHEMA IF EXISTS public CASCADE; CREATE SCHEMA public;"
        echo "Database schema reset successfully"
    
    - name: Bootstrap migrations (CI profile)
      working-directory: backend
      env:
        QUARKUS_PROFILE: ci
      run: |
        echo "Running migration bootstrap to ensure schema is ready..."
        ./mvnw -q -Dtest=de.freshplan.test.MigrationBootstrapIT test \
          -Dquarkus.devservices.enabled=false \
          -Dquarkus.datasource.devservices.enabled=false \
          -Dquarkus.flyway.migrate-at-start=true \
          -Dquarkus.flyway.out-of-order=true \
          -Dquarkus.flyway.locations=classpath:db/migration,classpath:db/testdata,classpath:db/ci-migrations,classpath:db/callbacks \
          -Dquarkus.datasource.jdbc.url="jdbc:postgresql://localhost:5432/freshplan?options=-c%20ci.build%3Dtrue" \
          -Dquarkus.datasource.username=freshplan \
          -Dquarkus.datasource.password=freshplan
        echo "✅ Migrations completed successfully"
    
    - name: Verify CI migrations applied
      env:
        PGPASSWORD: freshplan
      run: |
        echo "Checking that V9000 CI migration was applied..."
        psql -h localhost -U freshplan -d freshplan -c \
          "SELECT version, description FROM flyway_schema_history WHERE version >= '9000' ORDER BY installed_rank DESC LIMIT 5;"
        
        # Check FK configuration
        echo "Verifying FK CASCADE configuration..."
        FK_COUNT=$(psql -h localhost -U freshplan -d freshplan -tAc \
          "SELECT COUNT(*) FROM pg_constraint 
           WHERE contype='f' AND confrelid='public.customers'::regclass AND confdeltype='c'")
        echo "Found $FK_COUNT CASCADE FKs to customers table"
    
    - name: Count customers BEFORE tests
      env:
        PGPASSWORD: freshplan
      run: |
        # Now count after migrations are complete
        BEFORE=$(psql -h localhost -U freshplan -d freshplan -tAc "SELECT COUNT(*) FROM customers;")
        echo "CUSTOMERS_BEFORE=$BEFORE" >> $GITHUB_ENV
        echo "Customers before tests: $BEFORE"
    
    - name: Run all tests with CI profile
      working-directory: backend
      env:
        QUARKUS_PROFILE: ci
        MAVEN_OPTS: -Xmx2g -XX:MaxMetaspaceSize=512m
        RUN_SUFFIX: ${{ github.run_id }}
      run: |
        echo "Running tests with CI profile..."
        
        ./mvnw test \
          -B \
          -T 1C \
          -Djunit.jupiter.execution.timeout.default=2m \
          -Dmaven.test.failure.ignore=false \
          -DtrimStackTrace=false \
          -DRUN_SUFFIX=${{ github.run_id }} \
          -Dquarkus.devservices.enabled=false \
          -Dquarkus.datasource.devservices.enabled=false \
          -Dquarkus.flyway.migrate-at-start=true \
          -Dquarkus.flyway.out-of-order=true \
          -Dquarkus.flyway.locations=classpath:db/migration,classpath:db/testdata,classpath:db/ci-migrations,classpath:db/callbacks \
          -Dquarkus.datasource.jdbc.url="jdbc:postgresql://localhost:5432/freshplan?options=-c%20ci.build%3Dtrue" \
          -Dquarkus.datasource.username=freshplan \
          -Dquarkus.datasource.password=freshplan
        
        echo "✅ Tests completed"
    
    - name: Count customers AFTER tests & verify no growth
      env:
        PGPASSWORD: freshplan
      run: |
        AFTER=$(psql -h localhost -U freshplan -d freshplan -tAc "SELECT COUNT(*) FROM customers;")
        echo "Customers after tests: $AFTER"
        echo "Customers before tests: ${CUSTOMERS_BEFORE:-0}"
        DELTA=$((AFTER - ${CUSTOMERS_BEFORE:-0}))
        echo "Delta: $DELTA customers"
        
        if [ "$DELTA" -gt "0" ]; then
          echo "::error::Database grew by $DELTA customers during tests. Tests are not cleaning up properly!"
          exit 1
        else
          echo "✅ No database growth detected - tests are properly isolated"
        fi

    - name: Check for test isolation issues
      if: always()
      working-directory: backend
      run: |
        echo "Checking for common test isolation problems..."
        
        # Look for tests without @TestTransaction
        echo "Tests that might be missing @TestTransaction:"
        grep -r "@Test" src/test --include="*.java" | \
          grep -v "@TestTransaction" | \
          grep -E "(create|save|persist|insert|update|delete)" | \
          head -20 || echo "No obvious issues found"
        
        echo ""
        echo "Remember:"
        echo "- Use @TestTransaction for database tests"
        echo "- Each test should be self-contained"
        echo "- Don't rely on data from other tests"

    - name: Upload test reports
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports-${{ github.run_number }}
        path: |
          backend/target/surefire-reports/**
          backend/target/failsafe-reports/**