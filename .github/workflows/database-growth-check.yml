name: Database Growth Check

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: db-growth-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-database-growth:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: freshplan
          POSTGRES_PASSWORD: freshplan
          POSTGRES_DB: freshplan
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U freshplan -d freshplan"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-m2-${{ hashFiles('backend/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2-

    - name: Run all tests with CI profile
      working-directory: backend
      env:
        QUARKUS_PROFILE: ci
        MAVEN_OPTS: -Xmx2g -XX:MaxMetaspaceSize=512m
      run: |
        echo "Running tests with CI profile (includes clean database)..."
        
        # The CI profile has flyway.clean-at-start=true
        # This ensures each test run starts with a fresh database
        # If tests create data that persists, it's a test isolation bug
        
        ./mvnw test \
          -B \
          -Djunit.jupiter.execution.timeout.default=2m \
          -Dmaven.test.failure.ignore=false \
          -DtrimStackTrace=false
        
        echo "âœ… Tests completed"

    - name: Check for test isolation issues
      if: always()
      working-directory: backend
      run: |
        echo "Checking for common test isolation problems..."
        
        # Look for tests without @TestTransaction
        echo "Tests that might be missing @TestTransaction:"
        grep -r "@Test" src/test --include="*.java" | \
          grep -v "@TestTransaction" | \
          grep -E "(create|save|persist|insert|update|delete)" | \
          head -20 || echo "No obvious issues found"
        
        echo ""
        echo "Remember:"
        echo "- Use @TestTransaction for database tests"
        echo "- Each test should be self-contained"
        echo "- Don't rely on data from other tests"

    - name: Upload test reports
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports-${{ github.run_number }}
        path: |
          backend/target/surefire-reports/**
          backend/target/failsafe-reports/**