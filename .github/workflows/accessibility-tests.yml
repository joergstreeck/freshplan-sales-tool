name: Accessibility Tests (A11y)

# WCAG 2.1 Level AA Compliance Testing
# CI/CD Phase 3 - BATCH 2

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - '.github/workflows/accessibility-tests.yml'
  push:
    branches: [main, develop]
    paths:
      - 'frontend/**'
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write

concurrency:
  group: a11y-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  accessibility-tests:
    name: WCAG 2.1 AA Compliance
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build Frontend (Production)
        working-directory: frontend
        run: npm run build

      - name: Install Playwright Browsers
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Run Accessibility Tests
        working-directory: frontend
        continue-on-error: true  # Non-blocking - existing A11y violations need gradual fixes
        id: a11y-tests
        run: |
          echo "üîç Running WCAG 2.1 Level AA Accessibility Tests..."
          echo ""
          echo "Testing for (warnings, non-blocking):"
          echo "  ‚Ä¢ Color contrast violations"
          echo "  ‚Ä¢ Missing alt text"
          echo "  ‚Ä¢ Keyboard navigation"
          echo "  ‚Ä¢ Screen reader compatibility"
          echo "  ‚Ä¢ ARIA attributes"
          echo "  ‚Ä¢ Form labels"
          echo "  ‚Ä¢ Semantic HTML"
          echo ""

          npx playwright test accessibility.spec.ts --project=chromium || {
            echo ""
            echo "‚ö†Ô∏è  Accessibility Violations Detected (non-blocking)"
            echo ""
            echo "üìä Review the detailed accessibility report in artifacts."
            echo "üí° Common fixes:"
            echo "    - Add <main> landmark element"
            echo "    - Add <h1> heading to each page"
            echo "    - Add alt text to images"
            echo "    - Improve color contrast (min 4.5:1 for text)"
            echo "    - Add ARIA labels to interactive elements"
            echo ""
            echo "‚ÑπÔ∏è  Note: A11y tests are currently non-blocking to allow gradual fixes"
            echo "    See: https://github.com/joergstreeck/freshplan-sales-tool/issues/146"
          }

          echo ""
          echo "‚ÑπÔ∏è  Accessibility check completed (non-blocking)"

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-accessibility-report
          path: frontend/playwright-report/
          retention-days: 30

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-test-results
          path: frontend/test-results/
          retention-days: 7

      - name: Accessibility Report Summary
        if: always()
        run: |
          echo "## üîç Accessibility Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Standard:** WCAG 2.1 Level AA" >> $GITHUB_STEP_SUMMARY
          echo "**Tool:** axe-playwright + Playwright" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tests Run:" >> $GITHUB_STEP_SUMMARY
          echo "- Homepage accessibility" >> $GITHUB_STEP_SUMMARY
          echo "- Dashboard accessibility" >> $GITHUB_STEP_SUMMARY
          echo "- Leads page accessibility" >> $GITHUB_STEP_SUMMARY
          echo "- Customers page accessibility" >> $GITHUB_STEP_SUMMARY
          echo "- Keyboard navigation" >> $GITHUB_STEP_SUMMARY
          echo "- Form labels and ARIA" >> $GITHUB_STEP_SUMMARY
          echo "- Data table structure" >> $GITHUB_STEP_SUMMARY
          echo "- Modal focus trapping" >> $GITHUB_STEP_SUMMARY
          echo "- Color contrast" >> $GITHUB_STEP_SUMMARY
          echo "- Image alt text" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìä Detailed report available in artifacts" >> $GITHUB_STEP_SUMMARY

  accessibility-pipeline-gate:
    name: A11y Pipeline Complete
    needs: [accessibility-tests]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check accessibility status
        run: |
          # A11y tests are non-blocking to allow gradual fixes
          # See: https://github.com/joergstreeck/freshplan-sales-tool/issues/146

          if [[ "${{ needs.accessibility-tests.result }}" == "failure" ]]; then
            echo "‚ö†Ô∏è  Accessibility Tests found violations (non-blocking)"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ‚ö†Ô∏è  Accessibility Pipeline - Violations Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Accessibility violations detected but pipeline continues (non-blocking)." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Known Issues:**" >> $GITHUB_STEP_SUMMARY
            echo "- Missing \`<main>\` landmark element" >> $GITHUB_STEP_SUMMARY
            echo "- Missing \`<h1>\` heading on some pages" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the accessibility report artifact" >> $GITHUB_STEP_SUMMARY
            echo "2. Track fixes in Issue #146" >> $GITHUB_STEP_SUMMARY
            # Don't exit 1 - non-blocking
          else
            echo "‚úÖ Accessibility Pipeline PASSED!"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ‚úÖ Accessibility Pipeline - PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Result:** All pages meet WCAG 2.1 Level AA standards" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Impact:** Improved user experience for:" >> $GITHUB_STEP_SUMMARY
          echo "- Users with visual impairments" >> $GITHUB_STEP_SUMMARY
          echo "- Users with motor disabilities" >> $GITHUB_STEP_SUMMARY
          echo "- Screen reader users" >> $GITHUB_STEP_SUMMARY
          echo "- Keyboard-only users" >> $GITHUB_STEP_SUMMARY
