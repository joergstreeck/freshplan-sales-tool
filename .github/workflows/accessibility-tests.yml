name: Accessibility Tests (A11y)

# WCAG 2.1 Level AA Compliance Testing
# CI/CD Phase 3 - BATCH 2

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - '.github/workflows/accessibility-tests.yml'
  push:
    branches: [main, develop]
    paths:
      - 'frontend/**'
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write

concurrency:
  group: a11y-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  accessibility-tests:
    name: WCAG 2.1 AA Compliance
    runs-on: ubuntu-22.04
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build Frontend (Production)
        working-directory: frontend
        run: npm run build

      - name: Install Playwright Browsers
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Run Accessibility Tests
        working-directory: frontend
        run: |
          echo "ðŸ” Running WCAG 2.1 Level AA Accessibility Tests..."
          echo ""
          echo "Testing for:"
          echo "  â€¢ Color contrast violations"
          echo "  â€¢ Missing alt text"
          echo "  â€¢ Keyboard navigation"
          echo "  â€¢ Screen reader compatibility"
          echo "  â€¢ ARIA attributes"
          echo "  â€¢ Form labels"
          echo "  â€¢ Semantic HTML"
          echo ""

          npx playwright test accessibility.spec.ts --project=chromium || {
            echo ""
            echo "âŒ Accessibility Violations Detected!"
            echo ""
            echo "âš ï¸  Your changes do not meet WCAG 2.1 Level AA standards."
            echo ""
            echo "ðŸ“Š Review the detailed accessibility report in artifacts."
            echo "ðŸ’¡ Common fixes:"
            echo "    - Add alt text to images"
            echo "    - Improve color contrast (min 4.5:1 for text)"
            echo "    - Add ARIA labels to interactive elements"
            echo "    - Ensure keyboard navigation works"
            echo ""
            exit 1
          }

          echo "âœ… All accessibility tests passed (WCAG 2.1 AA compliant)"

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-accessibility-report
          path: frontend/playwright-report/
          retention-days: 30

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-test-results
          path: frontend/test-results/
          retention-days: 7

      - name: Accessibility Report Summary
        if: always()
        run: |
          echo "## ðŸ” Accessibility Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Standard:** WCAG 2.1 Level AA" >> $GITHUB_STEP_SUMMARY
          echo "**Tool:** axe-playwright + Playwright" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tests Run:" >> $GITHUB_STEP_SUMMARY
          echo "- Homepage accessibility" >> $GITHUB_STEP_SUMMARY
          echo "- Dashboard accessibility" >> $GITHUB_STEP_SUMMARY
          echo "- Leads page accessibility" >> $GITHUB_STEP_SUMMARY
          echo "- Customers page accessibility" >> $GITHUB_STEP_SUMMARY
          echo "- Keyboard navigation" >> $GITHUB_STEP_SUMMARY
          echo "- Form labels and ARIA" >> $GITHUB_STEP_SUMMARY
          echo "- Data table structure" >> $GITHUB_STEP_SUMMARY
          echo "- Modal focus trapping" >> $GITHUB_STEP_SUMMARY
          echo "- Color contrast" >> $GITHUB_STEP_SUMMARY
          echo "- Image alt text" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Detailed report available in artifacts" >> $GITHUB_STEP_SUMMARY

  accessibility-pipeline-gate:
    name: A11y Pipeline Complete
    needs: [accessibility-tests]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check accessibility status
        run: |
          if [[ "${{ needs.accessibility-tests.result }}" == "failure" ]]; then
            echo "âŒ Accessibility Tests FAILED"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## âŒ Accessibility Pipeline - FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your changes do not meet WCAG 2.1 Level AA accessibility standards." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the accessibility report artifact" >> $GITHUB_STEP_SUMMARY
            echo "2. Fix identified violations" >> $GITHUB_STEP_SUMMARY
            echo "3. Re-run tests locally: \`cd frontend && npm run test:e2e accessibility.spec.ts\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "âœ… Accessibility Pipeline PASSED!"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Accessibility Pipeline - PASSED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Result:** All pages meet WCAG 2.1 Level AA standards" >> $GITHUB_STEP_SUMMARY
          echo "**Impact:** Improved user experience for:" >> $GITHUB_STEP_SUMMARY
          echo "- Users with visual impairments" >> $GITHUB_STEP_SUMMARY
          echo "- Users with motor disabilities" >> $GITHUB_STEP_SUMMARY
          echo "- Screen reader users" >> $GITHUB_STEP_SUMMARY
          echo "- Keyboard-only users" >> $GITHUB_STEP_SUMMARY
