name: Security Pipeline

# Consolidated Security & Performance Workflow
# Sprint 2.1.7.7 - CI/CD Konsolidierung
#
# Extends security-gates.yml with:
# - OWASP Dependency Check (NEW)
# - Secrets Scanning (NEW)
# - Existing: Security Contracts, PR Template, Performance Smoke

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  schedule:
    # Run dependency check weekly (Monday 3 AM UTC)
    - cron: '0 3 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write
  security-events: write

concurrency:
  group: security-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # 1. Security Contract Tests
  # ============================================================================
  security-contracts:
    name: Security Contract Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      postgres:
        image: postgres:15-alpine
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: freshplan
          POSTGRES_PASSWORD: freshplan
          POSTGRES_DB: freshplan
        options: >-
          --health-cmd="pg_isready -U freshplan -d freshplan"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Security Contract Tests
        working-directory: backend
        run: |
          ./mvnw test -Dtest=*SecurityContractTest* \
            -Dquarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5432/freshplan \
            -Dquarkus.datasource.username=freshplan \
            -Dquarkus.datasource.password=freshplan

      - name: Fail-closed Verification
        working-directory: backend
        run: |
          ./scripts/verify-fail-closed-security.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-test-results
          path: backend/target/surefire-reports/
          retention-days: 7

  # ============================================================================
  # 2. PR Template Compliance
  # ============================================================================
  pr-template-check:
    name: PR Template Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 3
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check PR Description
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';

            // Check for required sections
            const requiredSections = [
              '## ðŸŽ¯ Ziel',
              '## âš ï¸ Risiko',
              '## ðŸ”„ Migrations-Schritte + Rollback',
              '## âš¡ Performance-Nachweis',
              '## ðŸ”’ Security-Checks',
              '## ðŸ“š SoT-Referenzen'
            ];

            const missingSections = [];
            for (const section of requiredSections) {
              if (!prBody.includes(section)) {
                missingSections.push(section);
              }
            }

            if (missingSections.length > 0) {
              core.setFailed(`PR Template incomplete. Missing sections: ${missingSections.join(', ')}`);

              // Add comment to PR
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `âŒ **PR Template Validation Failed**\n\nThe following required sections are missing:\n${missingSections.map(s => `- ${s}`).join('\n')}\n\nPlease update your PR description to include all required sections.`
              });
            } else {
              console.log('âœ… All required PR template sections present');
            }

  # ============================================================================
  # 3. OWASP Dependency Check (NEW)
  # ============================================================================
  owasp-dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'push' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run OWASP Dependency Check (Backend)
        working-directory: backend
        run: |
          # Download OWASP Dependency-Check CLI
          wget -q https://github.com/jeremylong/DependencyCheck/releases/download/v9.0.9/dependency-check-9.0.9-release.zip
          unzip -q dependency-check-9.0.9-release.zip

          # Run scan
          ./dependency-check/bin/dependency-check.sh \
            --project "FreshPlan Backend" \
            --scan target/quarkus-app/lib \
            --format HTML \
            --format JSON \
            --out reports \
            --suppression suppression.xml || true

          echo "ðŸ“Š OWASP Dependency Check completed"
        continue-on-error: true

      - name: Check for Critical Vulnerabilities
        working-directory: backend
        run: |
          if [ -f reports/dependency-check-report.json ]; then
            CRITICAL=$(jq '.dependencies[].vulnerabilities[] | select(.severity == "CRITICAL")' reports/dependency-check-report.json | wc -l)
            HIGH=$(jq '.dependencies[].vulnerabilities[] | select(.severity == "HIGH")' reports/dependency-check-report.json | wc -l)

            echo "ðŸ” Security Scan Results:"
            echo "- CRITICAL vulnerabilities: $CRITICAL"
            echo "- HIGH vulnerabilities: $HIGH"

            if [ "$CRITICAL" -gt 0 ]; then
              echo "âŒ CRITICAL vulnerabilities detected!"
              echo "Review the OWASP report artifact for details."
              exit 1
            fi

            if [ "$HIGH" -gt 5 ]; then
              echo "âš ï¸ More than 5 HIGH vulnerabilities detected!"
              echo "Review the OWASP report artifact for details."
            fi
          else
            echo "âš ï¸ No OWASP report generated"
          fi
        continue-on-error: true

      - name: Upload OWASP Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: owasp-dependency-check-report
          path: backend/reports/
          retention-days: 30

  # ============================================================================
  # 4. Secrets Scanning (NEW)
  # ============================================================================
  secrets-scan:
    name: Secrets & Credentials Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better scanning

      - name: Run Trufflehog Secrets Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: Check for hardcoded credentials
        run: |
          echo "ðŸ” Checking for hardcoded credentials..."

          # Check for common secret patterns
          FINDINGS=$(grep -r -E "(password|secret|api_key|apikey|token|access_key|private_key)\s*=\s*['\"](?!(test|mock|fake|dummy|example))[a-zA-Z0-9]{8,}" \
            --include="*.java" \
            --include="*.ts" \
            --include="*.tsx" \
            --include="*.js" \
            --include="*.jsx" \
            --exclude-dir=node_modules \
            --exclude-dir=target \
            --exclude-dir=dist \
            backend/ frontend/ || echo "")

          if [ -n "$FINDINGS" ]; then
            echo "âŒ Potential hardcoded credentials found:"
            echo "$FINDINGS"
            echo ""
            echo "âš ï¸ WARNING: Review these findings and use environment variables or secrets management instead."
            exit 1
          else
            echo "âœ… No obvious hardcoded credentials found"
          fi

      - name: Check .env files in repository
        run: |
          echo "ðŸ” Checking for committed .env files..."

          ENV_FILES=$(find . -name ".env" -o -name ".env.*" | grep -v "node_modules\|.example\|.template" || echo "")

          if [ -n "$ENV_FILES" ]; then
            echo "âŒ .env files should not be committed to the repository:"
            echo "$ENV_FILES"
            echo ""
            echo "âš ï¸ These files may contain secrets. Add them to .gitignore!"
            exit 1
          else
            echo "âœ… No .env files found in repository"
          fi

  # ============================================================================
  # 5. Performance Smoke Test
  # ============================================================================
  performance-smoke-test:
    name: Performance Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    services:
      postgres:
        image: postgres:15-alpine
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: freshplan
          POSTGRES_PASSWORD: freshplan
          POSTGRES_DB: freshplan
        options: >-
          --health-cmd="pg_isready -U freshplan -d freshplan"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build Backend
        working-directory: backend
        run: ./mvnw package -DskipTests

      - name: Start Backend
        working-directory: backend
        env:
          DB_URL: jdbc:postgresql://localhost:5432/freshplan
          DB_USER: freshplan
          DB_PASSWORD: freshplan
          QUARKUS_PROFILE: ci
        run: |
          java -Xms256m -Xmx512m \
            -Dquarkus.profile=ci \
            -jar target/quarkus-app/quarkus-run.jar &

          # Wait for startup
          for i in {1..30}; do
            sleep 2
            if curl -f http://localhost:8080/q/health 2>/dev/null; then
              echo "Application started successfully"
              break
            fi
          done

          # Verify startup
          if ! curl -f http://localhost:8080/q/health; then
            echo "Application failed to start after 60 seconds"
            exit 1
          fi

      - name: Run k6 Performance Smoke Test
        run: |
          echo "âš¡ Running k6 performance smoke test..."

          # Check if k6 test file exists
          if [ -f backend/src/test/k6/smoke-test.js ]; then
            docker run --rm -i \
              --network host \
              grafana/k6 run - < backend/src/test/k6/smoke-test.js || {
                echo "âš ï¸ k6 test failed or not found"
                echo "Target: P95 < 200ms"
              }
          else
            echo "âš ï¸ k6 smoke test file not found at backend/src/test/k6/smoke-test.js"
            echo "ðŸ“ Create this file to enable performance testing"
            echo "Target: P95 < 200ms"
          fi
        continue-on-error: true

      - name: Performance Check Summary
        run: |
          echo "ðŸ“Š Performance Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Target: P95 < 200ms" >> $GITHUB_STEP_SUMMARY
          echo "Status: Smoke test completed (see logs for details)" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Final Security Pipeline Gate
  # ============================================================================
  security-pipeline-complete:
    name: Security Pipeline Complete
    needs: [security-contracts, secrets-scan]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          if [[ "${{ needs.security-contracts.result }}" == "failure" ]] || \
             [[ "${{ needs.secrets-scan.result }}" == "failure" ]]; then
            echo "âŒ Security Pipeline FAILED"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## âŒ Security Pipeline - FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Security Contracts: ${{ needs.security-contracts.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- Secrets Scan: ${{ needs.secrets-scan.result }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ OWASP and Performance checks run separately (may have warnings)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "âœ… Security Pipeline PASSED!"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Security Pipeline - PASSED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Security Checks:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security Contracts Verified" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No Secrets Found in Code" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Additional Checks (informational):**" >> $GITHUB_STEP_SUMMARY
          echo "- OWASP Dependency Check: Runs weekly + on push" >> $GITHUB_STEP_SUMMARY
          echo "- Performance Smoke Test: Runs on push" >> $GITHUB_STEP_SUMMARY
