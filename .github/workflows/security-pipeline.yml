name: Security Pipeline

# Consolidated Security & Performance Workflow
# Sprint 2.1.7.7 - CI/CD Konsolidierung
#
# Extends security-gates.yml with:
# - OWASP Dependency Check (NEW)
# - Secrets Scanning (NEW)
# - Existing: Security Contracts, PR Template, Performance Smoke

on:
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'LICENSE'
      - '.gitignore'
  push:
    branches: [main, develop]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'LICENSE'
      - '.gitignore'
  schedule:
    # Run dependency check weekly (Monday 3 AM UTC)
    - cron: '0 3 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write
  security-events: write

concurrency:
  group: security-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # 1. Security Contract Tests
  # ============================================================================
  security-contracts:
    name: Security Contract Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      postgres:
        image: postgres:15-alpine
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: freshplan
          POSTGRES_PASSWORD: freshplan
          POSTGRES_DB: freshplan
        options: >-
          --health-cmd="pg_isready -U freshplan -d freshplan"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Security Contract Tests
        working-directory: backend
        run: |
          ./mvnw test -Dtest=*SecurityContractTest* \
            -Dquarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5432/freshplan \
            -Dquarkus.datasource.username=freshplan \
            -Dquarkus.datasource.password=freshplan

      - name: Fail-closed Verification
        working-directory: backend
        run: |
          ./scripts/verify-fail-closed-security.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-test-results
          path: backend/target/surefire-reports/
          retention-days: 7

  # ============================================================================
  # 2. PR Template Compliance
  # ============================================================================
  pr-template-check:
    name: PR Template Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 3
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check PR Description
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';

            // Check for required sections
            const requiredSections = [
              '## üéØ Ziel',
              '## ‚ö†Ô∏è Risiko',
              '## üîÑ Migrations-Schritte + Rollback',
              '## ‚ö° Performance-Nachweis',
              '## üîí Security-Checks',
              '## üìö SoT-Referenzen'
            ];

            const missingSections = [];
            for (const section of requiredSections) {
              if (!prBody.includes(section)) {
                missingSections.push(section);
              }
            }

            if (missingSections.length > 0) {
              core.setFailed(`PR Template incomplete. Missing sections: ${missingSections.join(', ')}`);

              // Add comment to PR
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `‚ùå **PR Template Validation Failed**\n\nThe following required sections are missing:\n${missingSections.map(s => `- ${s}`).join('\n')}\n\nPlease update your PR description to include all required sections.`
              });
            } else {
              console.log('‚úÖ All required PR template sections present');
            }

  # ============================================================================
  # 3. OWASP Dependency Check (NEW)
  # ============================================================================
  owasp-dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'push' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run OWASP Dependency Check (Backend)
        working-directory: backend
        run: |
          # Download OWASP Dependency-Check CLI
          wget -q https://github.com/jeremylong/DependencyCheck/releases/download/v9.0.9/dependency-check-9.0.9-release.zip
          unzip -q dependency-check-9.0.9-release.zip

          # Run scan
          ./dependency-check/bin/dependency-check.sh \
            --project "FreshPlan Backend" \
            --scan target/quarkus-app/lib \
            --format HTML \
            --format JSON \
            --out reports \
            --suppression suppression.xml || true

          echo "üìä OWASP Dependency Check completed"
        continue-on-error: true

      - name: Check for Critical Vulnerabilities
        working-directory: backend
        run: |
          if [ -f reports/dependency-check-report.json ]; then
            CRITICAL=$(jq '.dependencies[].vulnerabilities[] | select(.severity == "CRITICAL")' reports/dependency-check-report.json | wc -l)
            HIGH=$(jq '.dependencies[].vulnerabilities[] | select(.severity == "HIGH")' reports/dependency-check-report.json | wc -l)

            echo "üîç Security Scan Results:"
            echo "- CRITICAL vulnerabilities: $CRITICAL"
            echo "- HIGH vulnerabilities: $HIGH"

            if [ "$CRITICAL" -gt 0 ]; then
              echo "‚ùå CRITICAL vulnerabilities detected!"
              echo "Review the OWASP report artifact for details."
              exit 1
            fi

            if [ "$HIGH" -gt 5 ]; then
              echo "‚ö†Ô∏è More than 5 HIGH vulnerabilities detected!"
              echo "Review the OWASP report artifact for details."
            fi
          else
            echo "‚ö†Ô∏è No OWASP report generated"
          fi
        continue-on-error: true

      - name: Upload OWASP Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: owasp-dependency-check-report
          path: backend/reports/
          retention-days: 30

  # ============================================================================
  # 3.5. Trivy Container Scanning (NEW - BATCH 2)
  # ============================================================================
  trivy-container-scan:
    name: Trivy Container Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'push' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Trivy
        run: |
          # Install Trivy (latest version)
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy
          echo "‚úÖ Trivy installed: $(trivy --version)"

      - name: Build Backend Docker Image
        run: |
          echo "üê≥ Building backend Docker image..."
          # Build from repository root - Dockerfile expects backend/ subdirectory
          docker build -f docker/Dockerfile.backend -t freshplan-backend:latest .
          echo "‚úÖ Backend image built"

      - name: Build Frontend Docker Image
        run: |
          echo "üê≥ Building frontend Docker image..."
          # Build from repository root - Dockerfile expects frontend/ subdirectory
          docker build -f docker/Dockerfile.frontend -t freshplan-frontend:latest .
          echo "‚úÖ Frontend image built"

      - name: Scan Backend Image with Trivy
        run: |
          echo "üîç Scanning backend image for vulnerabilities..."

          # Scan with --ignore-unfixed: Only report CVEs that have fixes available
          # This is best practice - we can't fix what upstream hasn't patched
          trivy image \
            --severity CRITICAL,HIGH \
            --ignore-unfixed \
            --format json \
            --output trivy-backend-report.json \
            freshplan-backend:latest

          # Also generate table report for easy reading (all CVEs for visibility)
          trivy image \
            --severity CRITICAL,HIGH,MEDIUM \
            --format table \
            --output trivy-backend-report.txt \
            freshplan-backend:latest

          echo "‚úÖ Backend scan completed"

      - name: Scan Frontend Image with Trivy
        run: |
          echo "üîç Scanning frontend image for vulnerabilities..."

          # Scan with --ignore-unfixed: Only report CVEs that have fixes available
          trivy image \
            --severity CRITICAL,HIGH \
            --ignore-unfixed \
            --format json \
            --output trivy-frontend-report.json \
            freshplan-frontend:latest

          # Also generate table report for easy reading (all CVEs for visibility)
          trivy image \
            --severity CRITICAL,HIGH,MEDIUM \
            --format table \
            --output trivy-frontend-report.txt \
            freshplan-frontend:latest

          echo "‚úÖ Frontend scan completed"

      - name: Check for Critical Vulnerabilities (Backend)
        run: |
          echo "üîç Analyzing backend vulnerabilities (fixable only)..."

          if [ -f trivy-backend-report.json ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' trivy-backend-report.json)
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' trivy-backend-report.json)

            echo "üìä Backend Image Vulnerabilities (fixable):"
            echo "  - CRITICAL: $CRITICAL"
            echo "  - HIGH: $HIGH"

            if [ "$CRITICAL" -gt 0 ]; then
              echo ""
              echo "‚ùå CRITICAL fixable vulnerabilities detected in backend image!"
              echo "üìä Review trivy-backend-report.txt artifact for details."
              echo "üí° These CVEs have patches available - please update dependencies."
              exit 1
            fi

            if [ "$HIGH" -gt 5 ]; then
              echo ""
              echo "‚ö†Ô∏è More than 5 HIGH fixable vulnerabilities detected!"
              echo "üìä Consider updating base image or dependencies."
            fi

            echo "‚úÖ No critical fixable vulnerabilities in backend"
          else
            echo "‚ö†Ô∏è No backend Trivy report generated"
          fi

      - name: Check for Critical Vulnerabilities (Frontend)
        run: |
          echo "üîç Analyzing frontend vulnerabilities (fixable only)..."

          if [ -f trivy-frontend-report.json ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' trivy-frontend-report.json)
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' trivy-frontend-report.json)

            echo "üìä Frontend Image Vulnerabilities (fixable):"
            echo "  - CRITICAL: $CRITICAL"
            echo "  - HIGH: $HIGH"

            if [ "$CRITICAL" -gt 0 ]; then
              echo ""
              echo "‚ùå CRITICAL fixable vulnerabilities detected in frontend image!"
              echo "üìä Review trivy-frontend-report.txt artifact for details."
              echo "üí° These CVEs have patches available - please update dependencies."
              exit 1
            fi

            if [ "$HIGH" -gt 5 ]; then
              echo ""
              echo "‚ö†Ô∏è More than 5 HIGH fixable vulnerabilities detected!"
              echo "üìä Consider updating nginx or node base images."
            fi

            echo "‚úÖ No critical fixable vulnerabilities in frontend"
          else
            echo "‚ö†Ô∏è No frontend Trivy report generated"
          fi

      - name: Upload Trivy Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-container-scan-reports
          path: |
            trivy-backend-report.json
            trivy-backend-report.txt
            trivy-frontend-report.json
            trivy-frontend-report.txt
          retention-days: 30

      - name: Trivy Scan Summary
        if: always()
        run: |
          echo "## üîí Trivy Container Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Images Scanned:**" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: eclipse-temurin:17-jre-jammy" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: nginx:1.27-alpine" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f trivy-backend-report.json ] && [ -f trivy-frontend-report.json ]; then
            BACKEND_CRIT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' trivy-backend-report.json)
            BACKEND_HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' trivy-backend-report.json)
            FRONTEND_CRIT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' trivy-frontend-report.json)
            FRONTEND_HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' trivy-frontend-report.json)

            echo "**Backend Vulnerabilities:**" >> $GITHUB_STEP_SUMMARY
            echo "- CRITICAL: $BACKEND_CRIT" >> $GITHUB_STEP_SUMMARY
            echo "- HIGH: $BACKEND_HIGH" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "**Frontend Vulnerabilities:**" >> $GITHUB_STEP_SUMMARY
            echo "- CRITICAL: $FRONTEND_CRIT" >> $GITHUB_STEP_SUMMARY
            echo "- HIGH: $FRONTEND_HIGH" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "üìä Detailed HTML reports available in artifacts" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Trivy reports not generated" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # 4. Secrets Scanning (NEW)
  # ============================================================================
  secrets-scan:
    name: Secrets & Credentials Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better scanning

      - name: Check if scan is needed
        id: check-scan
        run: |
          # For direct pushes to main, check if BASE and HEAD are the same
          if [[ "${{ github.event_name }}" == "push" ]]; then
            BASE="${{ github.event.before }}"
            HEAD="${{ github.sha }}"

            # Skip scan if BASE is all zeros (new branch) or same as HEAD
            if [[ "$BASE" == "0000000000000000000000000000000000000000" ]] || [[ "$BASE" == "$HEAD" ]]; then
              echo "skip=true" >> $GITHUB_OUTPUT
              echo "‚è≠Ô∏è Skipping TruffleHog scan - no diff to scan (direct push or new branch)"
            else
              echo "skip=false" >> $GITHUB_OUTPUT
              echo "‚úÖ TruffleHog scan will run (BASE: $BASE, HEAD: $HEAD)"
            fi
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Trufflehog Secrets Scan
        if: steps.check-scan.outputs.skip != 'true'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.before }}
          head: ${{ github.sha }}
          extra_args: --debug --only-verified

      - name: Check for hardcoded credentials
        run: |
          echo "üîç Checking for hardcoded credentials..."

          # Check for common secret patterns
          FINDINGS=$(grep -r -E "(password|secret|api_key|apikey|token|access_key|private_key)\s*=\s*['\"](?!(test|mock|fake|dummy|example))[a-zA-Z0-9]{8,}" \
            --include="*.java" \
            --include="*.ts" \
            --include="*.tsx" \
            --include="*.js" \
            --include="*.jsx" \
            --exclude-dir=node_modules \
            --exclude-dir=target \
            --exclude-dir=dist \
            backend/ frontend/ || echo "")

          if [ -n "$FINDINGS" ]; then
            echo "‚ùå Potential hardcoded credentials found:"
            echo "$FINDINGS"
            echo ""
            echo "‚ö†Ô∏è WARNING: Review these findings and use environment variables or secrets management instead."
            exit 1
          else
            echo "‚úÖ No obvious hardcoded credentials found"
          fi

      - name: Check .env files in repository
        run: |
          echo "üîç Checking for committed .env files..."

          # Find .env files but exclude:
          # - node_modules
          # - .example/.template files (safe)
          # - .development files (allowed - no real secrets, only config)
          ENV_FILES=$(find . -name ".env" -o -name ".env.*" | \
            grep -v "node_modules" | \
            grep -v ".example" | \
            grep -v ".template" | \
            grep -v ".development" | \
            grep -v ".test" | \
            grep -v ".ci" || echo "")

          if [ -n "$ENV_FILES" ]; then
            echo "‚ùå Production .env files should not be committed to the repository:"
            echo "$ENV_FILES"
            echo ""
            echo "‚ö†Ô∏è These files may contain secrets. Add them to .gitignore!"
            exit 1
          else
            echo "‚úÖ No production .env files found in repository"
            echo "   (.env.development and .env.test are allowed - they contain only config, no secrets)"
          fi

  # ============================================================================
  # 5. Performance Smoke Test
  # ============================================================================
  performance-smoke-test:
    name: Performance Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    services:
      postgres:
        image: postgres:15-alpine
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: freshplan
          POSTGRES_PASSWORD: freshplan
          POSTGRES_DB: freshplan
        options: >-
          --health-cmd="pg_isready -U freshplan -d freshplan"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build Backend
        working-directory: backend
        run: ./mvnw package -DskipTests

      - name: Start Backend
        working-directory: backend
        run: |
          # Start Quarkus with test profile (disables auth, enables CORS)
          java -Xms256m -Xmx512m \
            -Dquarkus.profile=test \
            -Dquarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5432/freshplan \
            -Dquarkus.datasource.username=freshplan \
            -Dquarkus.datasource.password=freshplan \
            -Dquarkus.flyway.migrate-at-start=true \
            -jar target/quarkus-app/quarkus-run.jar &

          BACKEND_PID=$!
          echo "Backend started with PID: $BACKEND_PID"

          # Wait for application to be fully ready (health check)
          echo "Waiting for backend to start..."
          for i in {1..60}; do
            sleep 2
            if curl -sf http://localhost:8080/q/health/ready 2>/dev/null; then
              echo "Backend is ready after $((i*2)) seconds"
              # Additional wait for API initialization
              sleep 3
              break
            fi
            echo "Waiting... ($((i*2))s)"
          done

          # Final verification
          if ! curl -sf http://localhost:8080/q/health/ready; then
            echo "Backend failed to start after 120 seconds"
            kill $BACKEND_PID 2>/dev/null || true
            exit 1
          fi

          # Test API endpoint is responding
          echo "Testing API endpoint..."
          if curl -sf http://localhost:8080/q/health; then
            echo "Health check passed"
          else
            echo "Warning: API health check failed"
          fi

      - name: Run k6 Performance Smoke Test (BLOCKING)
        run: |
          echo "‚ö° Running k6 performance smoke test..."

          # Pre-flight check: ensure backend is really responding
          echo "Pre-flight check: verifying backend is ready..."
          if ! curl -sf http://localhost:8080/q/health/ready; then
            echo "‚ùå Backend is not responding! Skipping k6 test."
            echo "This may indicate a startup issue."
            exit 1
          fi
          echo "‚úÖ Backend is responding"

          # Check if k6 test file exists
          if [ -f backend/src/test/k6/smoke-test.js ]; then
            docker run --rm -i \
              --network host \
              grafana/k6 run - < backend/src/test/k6/smoke-test.js || {
                echo ""
                echo "‚ùå Performance Threshold Violation!"
                echo ""
                echo "‚ö†Ô∏è  Your changes do not meet the performance requirements:"
                echo "    ‚Ä¢ P95 response time: <200ms"
                echo "    ‚Ä¢ Server errors: <5"
                echo ""
                echo "üí° Review the k6 test output above for details."
                exit 1
              }
            echo "‚úÖ Performance thresholds met (P95 <200ms, server errors <5)"
          else
            echo "‚ö†Ô∏è k6 smoke test file not found at backend/src/test/k6/smoke-test.js"
            echo "üìù Create this file to enable performance testing"
            echo "Target: P95 < 200ms"
          fi

      - name: Performance Check Summary
        run: |
          echo "üìä Performance Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Target: P95 < 200ms" >> $GITHUB_STEP_SUMMARY
          echo "Status: Smoke test completed (see logs for details)" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Final Security Pipeline Gate
  # ============================================================================
  security-pipeline-complete:
    name: Security Pipeline Complete
    needs: [security-contracts, secrets-scan]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          if [[ "${{ needs.security-contracts.result }}" == "failure" ]] || \
             [[ "${{ needs.secrets-scan.result }}" == "failure" ]]; then
            echo "‚ùå Security Pipeline FAILED"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ‚ùå Security Pipeline - FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Security Contracts: ${{ needs.security-contracts.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- Secrets Scan: ${{ needs.secrets-scan.result }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ö†Ô∏è OWASP and Performance checks run separately (may have warnings)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "‚úÖ Security Pipeline PASSED!"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ‚úÖ Security Pipeline - PASSED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Security Checks:**" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Security Contracts Verified" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ No Secrets Found in Code" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Additional Checks (informational):**" >> $GITHUB_STEP_SUMMARY
          echo "- OWASP Dependency Check: Runs weekly + on push" >> $GITHUB_STEP_SUMMARY
          echo "- Performance Smoke Test: Runs on push" >> $GITHUB_STEP_SUMMARY
