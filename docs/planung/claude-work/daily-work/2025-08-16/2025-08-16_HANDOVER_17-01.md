# ü§ù √úbergabe: 2025-08-16 17:01
**Branch:** feature/refactor-large-services
**Ge√§nderte Dateien:** 0
**Letzter Commit:** a04abea04 fix(ci): make CiFkSanityIT robust with OID-based self-FK detection

## üö® KRITISCHE INFORMATIONEN

### ‚ö†Ô∏è N√ÑCHSTE MIGRATION-NUMMER: V225
**NIEMALS eine bereits verwendete Nummer nutzen!**
**Hinweis:** Das Skript zeigt f√§lschlicherweise V10 an, aber die korrekte n√§chste Nummer ist V225!

### üìç Working Directory
```
Aktuell: /Users/joergstreeck/freshplan-sales-tool/backend
Projekt: /Users/joergstreeck/freshplan-sales-tool
```

## üìã TODO-Status

### Aktuelle Session (CI-Fix f√ºr PR #5):

**üö® KRITISCHE AUFGABE: CI f√ºr PR #5 gr√ºn bekommen**

Das Team arbeitet seit heute Morgen daran, die CI-Pipeline f√ºr PR #5 (CQRS Backend Refactoring) zu fixen.

**Aktueller Stand (16.08.2025 17:01):**
- ‚úÖ **3 von 5 CI-Jobs sind gr√ºn** (database-growth-check, test-data-initialization-check, test-isolation-check)
- ‚ùå **2 Jobs noch rot** (backend-ci, backend-integration-tests)
- **69 Test-Fehler** in CustomerQueryServiceIntegrationTest, HtmlExportQueryServiceTest, OpportunityRepositoryTest
- **Hauptproblem:** Duplicate Key Violations wegen nicht-eindeutiger Test-Daten

**Was bereits versucht wurde:**
1. ‚úÖ V223 Migration f√ºr audit_trail Partitionen gefixt
2. ‚úÖ V9000 Migration f√ºr CI FK CASCADE implementiert  
3. ‚úÖ CiFkSanityIT robust mit OID-basierter Self-FK-Erkennung
4. ‚úÖ DevServices in CI disabled
5. ‚è≥ UniqueData Pattern vom Team vorgeschlagen (noch nicht implementiert)

### üìù Offene TODOs aus dieser Session:
- ‚è≥ **UniqueData.java** mit ThreadLocal und email() implementieren
- ‚è≥ **TestFixtures.java** mit Builder-Pattern erstellen
- ‚è≥ **3 Haupttestklassen** auf UniqueData umstellen
- ‚è≥ **Optional:** V9003 Verify-Migration hinzuf√ºgen
- ‚è≥ **CI gr√ºn bekommen** - finale Verifikation

## üéØ N√§chster Schritt

### PRIORIT√ÑT 1: UniqueData Pattern implementieren

Das Team hat eine umfassende L√∂sung f√ºr die Duplicate-Key-Probleme bereitgestellt:

1. **UniqueData.java erstellen** mit:
   - ThreadLocal SecureRandom f√ºr Thread-Safety
   - RUN_SUFFIX aus GitHub Run ID oder Timestamp
   - Fork-Number aus surefire.forkNumber
   - email() Methode f√ºr eindeutige E-Mail-Adressen

2. **TestFixtures.java mit Builder-Pattern** f√ºr:
   - CustomerData, ContactData, OpportunityData
   - Automatische Verwendung von UniqueData
   - Fluent API f√ºr Test-Daten-Erstellung

3. **3 Haupttestklassen migrieren:**
   - CustomerQueryServiceIntegrationTest
   - HtmlExportQueryServiceTest  
   - OpportunityRepositoryTest

### Befehle f√ºr die Implementierung:
```bash
cd /Users/joergstreeck/freshplan-sales-tool/backend

# 1. UniqueData.java erstellen
# 2. TestFixtures.java implementieren
# 3. Tests anpassen
# 4. CI-Tests lokal ausf√ºhren:
./mvnw test -Dtest="CustomerQueryServiceIntegrationTest,HtmlExportQueryServiceTest,OpportunityRepositoryTest" \
  -Dquarkus.profile=ci \
  -DRUN_SUFFIX=local-test

# 5. Bei Erfolg: Commit und Push
git add .
git commit -m "fix(tests): implement UniqueData pattern for test isolation"
git push
```

## üîß Technische Details

### Wichtige Dateien aus dieser Session:

**Bereits implementiert:**
- `/backend/src/main/resources/db/migration/V223__audit_trail_partitions_2025.sql` - Partitionen mit Overlap-Prevention
- `/backend/src/test/resources/db/ci-migrations/V9000__fk_cascade_for_tests.sql` - FK CASCADE f√ºr CI
- `/backend/src/test/java/de/freshplan/test/CiFkSanityIT.java` - Robuster FK-Check
- `/.github/workflows/backend-ci.yml` - Mit Bootstrap und Verify-Steps
- `/.github/workflows/database-growth-check.yml` - Mit CI-Profile und Bootstrap

**Noch zu implementieren (vom Team bereitgestellt):**
- `/backend/src/test/java/de/freshplan/testsupport/UniqueData.java`
- `/backend/src/test/java/de/freshplan/testsupport/TestFixtures.java`

### CI-Status Links:
- PR #5: https://github.com/freshplan/freshplan-sales-tool/pull/5
- Letzte CI-Runs sollten in GitHub Actions sichtbar sein

## ‚ö†Ô∏è Bekannte Probleme

1. **Duplicate Key Violations:** Tests verwenden hardcodierte Werte wie "KD-2025-00002"
2. **69 Test-Fehler** in 3 Haupttestklassen wegen fehlender Eindeutigkeit
3. **Mockito Matcher:** Konsistenz-Probleme bei ArgumentMatchers
4. **Script-Bug:** get-next-migration.sh zeigt V10 statt V225

## üìù Notizen f√ºr die n√§chste Session

**Das Team hat heute intensiv an der CI gearbeitet:**
- Mehrere Iterationen mit Fixes f√ºr Partitionen, FKs, und Test-Isolation
- Sehr detaillierte Analyse und schrittweise Verbesserung
- UniqueData-Pattern als finale L√∂sung identifiziert

**Empfehlung:** 
1. Zuerst die UniqueData-Implementation abschlie√üen
2. Dann die 3 Haupttestklassen migrieren
3. CI sollte dann gr√ºn werden
4. Danach kann mit Phase 15 (Performance Testing) fortgefahren werden

_Handover erstellt am 16.08.2025 17:01_
_Branch: feature/refactor-large-services_
_Hauptziel: CI f√ºr PR #5 gr√ºn bekommen_
