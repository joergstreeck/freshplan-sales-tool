# ğŸ”„ STANDARDÃœBERGABE - 07.07.2025 12:50

**WICHTIG: Lies ZUERST diese Dokumente in dieser Reihenfolge:**
1. `/docs/CLAUDE.md` (Arbeitsrichtlinien und Standards)
2. Diese Ãœbergabe
3. `/docs/STANDARDUBERGABE_NEU.md` als Hauptanleitung

## ğŸ“š Das 3-STUFEN-SYSTEM verstehen

**STANDARDUBERGABE_NEU.md** (Hauptdokument)
- 5-Schritt-Prozess: System-Check â†’ Orientierung â†’ Arbeiten â†’ ProblemlÃ¶sung â†’ Ãœbergabe
- Verwende IMMER als primÃ¤re Anleitung
- EnthÃ¤lt alle wichtigen Scripts und Befehle

**STANDARDUBERGABE_KOMPAKT.md** (Ultra-kurz)
- Nur fÃ¼r Quick-Reference wenn du den Prozess schon kennst
- Komprimierte Version fÃ¼r erfahrene Sessions

**STANDARDUBERGABE.md** (VollstÃ¤ndig)
- Nur bei ernsten Problemen verwenden
- Detaillierte Troubleshooting-Anleitungen

## ğŸ¯ AKTUELLER STAND (Code-Inspektion-Validiert)

### âœ… SYSTEM-STATUS (12:50 Uhr)
```
validate-config.sh: âœ… Alle Tools vorhanden
check-services.sh:  âœ… Alle Services laufen (Backend:8080, Frontend:5173, PostgreSQL:5432, Keycloak:8180)
```

### ğŸ—ï¸ IMPLEMENTIERTE FEATURES (Code-validiert)
- âœ… Backend Sales Cockpit API vollstÃ¤ndig implementiert (`/api/sales-cockpit/dashboard/{userId}` und `/api/sales-cockpit/dashboard/dev`)
- âœ… Development Mock-Endpunkt funktioniert mit statischen Testdaten
- âœ… Testcontainers-Konfiguration lÃ¤uft einwandfrei
- âœ… Alle Backend-Tests grÃ¼n (6 Integration Tests bestehen)

## ğŸ“‹ WAS WURDE HEUTE GEMACHT?

### Seeding-Migration fÃ¼r Entwicklungsdatenbank

1. **Ordnerstruktur erstellt:**
   - `backend/src/main/resources/db/migration/dev/` fÃ¼r Entwicklungs-Migrationen
   - Flyway-Konfiguration angepasst: `%dev.quarkus.flyway.locations=classpath:db/migration,classpath:db/migration/dev`

2. **Migration V99__seed_intelligent_test_data.sql erstellt:**
   - 4 Test-User (Vertriebsmitarbeiter) mit verschiedenen Rollen
   - 22 Kunden mit verschiedenen Szenarien:
     - Gesunde Partner-Kunden (regelmÃ¤ÃŸiger Kontakt)
     - Risiko-Kunden (60+, 90+, 120+ Tage kein Kontakt)
     - Neue Leads ohne Kontakt
     - Inaktive/pausierte Kunden
     - Prospects in Verhandlung
     - Kunden ohne zugewiesenen Vertrieb
     - Filial-Strukturen (Parent-Child)
   - Timeline Events fÃ¼r ausgewÃ¤hlte Kunden
   - Statistik-Ausgabe am Ende der Migration

## ğŸ› ï¸ WAS FUNKTIONIERT?

- âœ… Migration-Datei wurde erfolgreich erstellt
- âœ… Flyway-Konfiguration erkennt den dev-Ordner
- âœ… Backend startet und versucht Migration auszufÃ¼hren
- âœ… Struktur der Testdaten ist sinnvoll und vielfÃ¤ltig

## ğŸš¨ WELCHE FEHLER GIBT ES?

### Hauptproblem: Migration schlÃ¤gt fehl

**Fehler 1:** Column `roles` existiert nicht in `app_user`
- **Ursache:** Rollen werden in separater Tabelle `user_roles` gespeichert
- **LÃ¶sung:** âœ… Bereits behoben - INSERT fÃ¼r `user_roles` hinzugefÃ¼gt

**Fehler 2:** Column `importance_level` existiert nicht in `customers`
- **Ursache:** Diese Spalte gibt es nicht in der Customer-Entity
- **LÃ¶sung:** âœ… Bereits behoben - Spalte aus INSERT entfernt

**Fehler 3:** Column `assigned_sales_rep_id` existiert nicht in `customers`
- **Ursache:** Die Spalte heiÃŸt anders oder existiert nicht
- **Status:** âŒ NOCH NICHT GELÃ–ST
- **Problem:** Ohne Zugriff auf die tatsÃ¤chliche DB-Struktur schwer zu beheben

## ğŸ”§ WIE WURDEN SIE GELÃ–ST / WAS IST ZU TUN?

### Bereits gelÃ¶ste Probleme:
1. User-Rollen werden jetzt korrekt in `user_roles` Tabelle eingefÃ¼gt
2. `importance_level` wurde aus Customer-INSERTs entfernt
3. Timeline Events nutzen jetzt `performed_by` (String) statt `performed_by_id`

### Noch zu lÃ¶sen:
1. **Herausfinden der korrekten Spalte fÃ¼r Sales Rep Zuordnung:**
   ```bash
   # Option 1: In der DB nachschauen
   docker exec -it freshplan-postgres psql -U freshplan -d freshplan -c "\d customers"
   
   # Option 2: Customer Entity analysieren
   grep -n "sales\|rep\|assigned" backend/src/main/java/de/freshplan/domain/customer/entity/Customer.java
   ```

2. **Migration anpassen:**
   - Entweder die korrekte Spalte verwenden
   - Oder die Sales Rep Zuordnung komplett entfernen (vereinfachter Ansatz)

## ğŸ“ˆ NÃ„CHSTE KONKRETE SCHRITTE

1. **Customer Entity analysieren** (5 Min)
   - Finde heraus, wie die Sales Rep Zuordnung tatsÃ¤chlich heiÃŸt
   - PrÃ¼fe ob es Ã¼berhaupt eine direkte Zuordnung gibt

2. **Migration korrigieren** (10 Min)
   - Passe die INSERT Statements entsprechend an
   - Vereinfache ggf. die Migration (ohne Sales Rep Zuordnung)

3. **Migration testen** (5 Min)
   ```bash
   # Backend neu starten
   ./scripts/stop-dev.sh && ./scripts/start-backend.sh
   
   # Log beobachten
   tail -f logs/backend.log | grep -E "(Migration|V99)"
   ```

4. **Backend-Response verifizieren** (5 Min)
   ```bash
   # Dev-Endpunkt testen
   curl -s http://localhost:8080/api/sales-cockpit/dashboard/dev | jq '.statistics'
   
   # Sollte jetzt hÃ¶here Zahlen zeigen (22 Kunden statt Mock-Daten)
   ```

## ğŸ“š MASSGEBLICHE DOKUMENTE

- **Aktueller Master Plan:** `/docs/CRM_COMPLETE_MASTER_PLAN.md` (Phase 1, Punkt 3: Mock-Endpunkte)
- **Backend-Architektur:** `/CLAUDE.md` Abschnitt 0.1 (Backend-Struktur)
- **Flyway-Dokumentation:** FÃ¼r Location-Konfiguration und Migration-Naming

## ğŸš€ NACH KOMPRIMIERUNG SOFORT AUSFÃœHREN

```bash
# 1. Zum Projekt wechseln
cd /Users/joergstreeck/freshplan-sales-tool

# 2. System-Check und Services starten
./scripts/validate-config.sh
./scripts/check-services.sh

# Falls Services nicht laufen:
./scripts/start-services.sh

# 3. Git-Status
git status
git log --oneline -5

# 4. TODO-Status
TodoRead

# 5. Migration-Status prÃ¼fen
ls -la backend/src/main/resources/db/migration/dev/
tail -n 50 logs/backend.log | grep -E "(Migration|ERROR)"

# 6. Customer Entity nach Sales Rep Spalte durchsuchen
grep -n "@ManyToOne\|@JoinColumn\|sales\|rep" backend/src/main/java/de/freshplan/domain/customer/entity/Customer.java

# 7. Falls gefunden, Migration anpassen
code backend/src/main/resources/db/migration/dev/V99__seed_intelligent_test_data.sql
```

## ğŸ” DEBUGGING-HILFE

Falls die Migration weiterhin fehlschlÃ¤gt:

1. **Vereinfachter Ansatz:**
   - Entferne alle Sales Rep Zuordnungen aus der Migration
   - Fokussiere dich nur auf die Kern-Kundendaten

2. **DB-Schema prÃ¼fen:**
   ```bash
   # Alle Tabellen anzeigen
   docker exec -it freshplan-postgres psql -U freshplan -d freshplan -c "\dt"
   
   # Customer-Struktur anzeigen
   docker exec -it freshplan-postgres psql -U freshplan -d freshplan -c "\d customers"
   ```

3. **Schrittweise vorgehen:**
   - Erst nur User erstellen
   - Dann nur Kunden ohne Beziehungen
   - Dann Timeline Events

**WICHTIG:** Die Grundidee der Seeding-Migration ist gut! Es fehlt nur die korrekte Anpassung an das tatsÃ¤chliche DB-Schema.