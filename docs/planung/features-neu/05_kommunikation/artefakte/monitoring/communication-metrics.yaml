# Prometheus Metrics Configuration - Communication Module
# Enhanced Business Metrics and SLA Monitoring

# Business Metrics
communication_metrics:
  # Thread Metrics
  communication_threads_total:
    type: counter
    help: "Total number of communication threads created"
    labels: ["territory", "channel", "status", "customer_type"]

  communication_threads_active:
    type: gauge
    help: "Number of currently active threads"
    labels: ["territory", "channel", "priority"]

  communication_thread_resolution_time_seconds:
    type: histogram
    help: "Time taken to resolve threads"
    buckets: [300, 600, 1800, 3600, 7200, 14400, 28800, 86400]
    labels: ["territory", "channel", "priority"]

  communication_thread_messages_per_thread:
    type: histogram
    help: "Number of messages per thread"
    buckets: [1, 2, 3, 5, 10, 15, 20, 30, 50]
    labels: ["channel", "customer_type"]

  # Message Metrics
  communication_messages_sent_total:
    type: counter
    help: "Total messages sent"
    labels: ["channel", "type", "territory"]

  communication_messages_received_total:
    type: counter
    help: "Total messages received"
    labels: ["channel", "territory", "sender_type"]

  communication_message_send_duration_seconds:
    type: histogram
    help: "Time to send message"
    buckets: [0.1, 0.25, 0.5, 1, 2, 5, 10]
    labels: ["channel", "priority"]

  # B2B Food Specific Metrics
  sample_followups_sent_total:
    type: counter
    help: "Total sample follow-ups sent"
    labels: ["timing", "territory", "customer_type"]

  sample_followup_response_rate:
    type: gauge
    help: "Response rate for sample follow-ups"
    labels: ["timing", "territory"]

  sample_to_order_conversion_rate:
    type: gauge
    help: "Conversion rate from sample to order"
    labels: ["territory", "product_category"]

  multi_contact_threads_ratio:
    type: gauge
    help: "Ratio of threads with multiple contacts (KÃ¼chenchef + Einkauf)"
    labels: ["territory", "customer_type"]

  # Email Specific Metrics
  email_bounce_rate:
    type: gauge
    help: "Email bounce rate"
    labels: ["bounce_type", "territory"]

  email_open_rate:
    type: gauge
    help: "Email open rate"
    labels: ["message_type", "territory"]

  email_outbox_queue_size:
    type: gauge
    help: "Current email outbox queue size"
    labels: ["status", "priority"]

  email_outbox_processing_time_seconds:
    type: histogram
    help: "Time to process outbox emails"
    buckets: [0.5, 1, 2, 5, 10, 30, 60]

  email_retry_count:
    type: histogram
    help: "Number of retries per email"
    buckets: [0, 1, 2, 3, 4, 5]
    labels: ["failure_reason"]

  # SLA Metrics
  sla_compliance_rate:
    type: gauge
    help: "SLA compliance rate"
    labels: ["sla_type", "priority", "territory"]

  sla_breach_total:
    type: counter
    help: "Total SLA breaches"
    labels: ["sla_type", "severity", "territory"]

  sla_response_time_seconds:
    type: histogram
    help: "Time to first response"
    buckets: [900, 1800, 3600, 7200, 14400, 28800, 86400]
    labels: ["priority", "channel"]

  sla_task_processing_time_seconds:
    type: histogram
    help: "Time to process SLA tasks"
    buckets: [0.1, 0.5, 1, 2, 5, 10]
    labels: ["task_type"]

  sla_escalations_total:
    type: counter
    help: "Total SLA escalations"
    labels: ["escalation_level", "reason", "territory"]

  # Territory Performance
  territory_activity_score:
    type: gauge
    help: "Territory activity score (composite metric)"
    labels: ["territory", "sales_rep"]

  territory_response_time_p95_seconds:
    type: gauge
    help: "95th percentile response time by territory"
    labels: ["territory"]

  # Customer Journey Metrics
  customer_journey_stage_duration_seconds:
    type: histogram
    help: "Time spent in each customer journey stage"
    buckets: [3600, 86400, 259200, 604800, 1209600, 2592000]
    labels: ["stage", "customer_type", "territory"]

  customer_engagement_score:
    type: gauge
    help: "Customer engagement score based on communication"
    labels: ["customer_id", "territory"]

  # Concurrency and Performance
  concurrent_thread_updates:
    type: gauge
    help: "Number of concurrent thread updates"

  etag_conflicts_total:
    type: counter
    help: "Total ETag conflicts encountered"
    labels: ["resource_type"]

  database_connection_pool_usage:
    type: gauge
    help: "Database connection pool usage"
    labels: ["pool_name", "status"]

# Alert Rules
alert_rules:
  - alert: HighEmailBounceRate
    expr: email_bounce_rate{bounce_type="HARD"} > 0.05
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High email bounce rate detected"
      description: "Hard bounce rate is {{ $value | humanizePercentage }} for territory {{ $labels.territory }}"

  - alert: SLABreachCritical
    expr: rate(sla_breach_total[5m]) > 0.1
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "Critical SLA breaches occurring"
      description: "SLA breach rate is {{ $value }} per second"

  - alert: EmailOutboxBacklog
    expr: email_outbox_queue_size{status="PENDING"} > 100
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "Email outbox backlog growing"
      description: "{{ $value }} emails pending in outbox"

  - alert: LowSampleFollowupResponse
    expr: sample_followup_response_rate < 0.2
    for: 1d
    labels:
      severity: warning
    annotations:
      summary: "Low response rate for sample follow-ups"
      description: "Response rate is {{ $value | humanizePercentage }} for {{ $labels.timing }} follow-ups"

  - alert: TerritoryInactive
    expr: territory_activity_score < 0.3
    for: 3d
    labels:
      severity: warning
    annotations:
      summary: "Territory showing low activity"
      description: "Territory {{ $labels.territory }} activity score is {{ $value }}"

  - alert: HighConcurrentConflicts
    expr: rate(etag_conflicts_total[5m]) > 1
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High rate of concurrent update conflicts"
      description: "{{ $value }} conflicts per second on {{ $labels.resource_type }}"

  - alert: DatabaseConnectionPoolExhaustion
    expr: database_connection_pool_usage{status="active"} / database_connection_pool_usage{status="max"} > 0.9
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "Database connection pool near exhaustion"
      description: "Connection pool {{ $labels.pool_name }} is {{ $value | humanizePercentage }} utilized"

# Grafana Dashboard Queries
dashboard_queries:
  communication_overview:
    - title: "Active Threads by Channel"
      query: 'sum(communication_threads_active) by (channel)'
      visualization: pie_chart

    - title: "Message Volume Trend"
      query: 'rate(communication_messages_sent_total[1h])'
      visualization: time_series

    - title: "SLA Compliance"
      query: 'sla_compliance_rate'
      visualization: gauge
      thresholds: [0.8, 0.9, 0.95]

  sample_management:
    - title: "Sample Follow-up Funnel"
      queries:
        - 'sum(sample_followups_sent_total) by (timing)'
        - 'sum(sample_followups_sent_total) * sample_followup_response_rate'
        - 'sum(sample_followups_sent_total) * sample_to_order_conversion_rate'
      visualization: funnel

    - title: "T+3 vs T+7 Performance"
      query: 'sample_followup_response_rate'
      group_by: timing
      visualization: bar_chart

  email_performance:
    - title: "Email Processing Pipeline"
      queries:
        - 'email_outbox_queue_size{status="PENDING"}'
        - 'email_outbox_queue_size{status="SENDING"}'
        - 'rate(communication_messages_sent_total{channel="EMAIL"}[5m])'
      visualization: status_timeline

    - title: "Bounce Rate by Type"
      query: 'email_bounce_rate'
      group_by: bounce_type
      visualization: stacked_bar

  territory_performance:
    - title: "Territory Heatmap"
      query: 'territory_activity_score'
      visualization: heatmap
      dimensions: [territory, week]

    - title: "Response Time by Territory"
      query: 'territory_response_time_p95_seconds'
      visualization: bar_chart
      sort: desc

  customer_journey:
    - title: "Journey Stage Duration"
      query: 'histogram_quantile(0.5, customer_journey_stage_duration_seconds)'
      group_by: stage
      visualization: sankey_diagram

    - title: "Engagement Score Distribution"
      query: 'customer_engagement_score'
      visualization: histogram
      buckets: 20

# Recording Rules (for performance)
recording_rules:
  - record: communication:threads:resolution_time_p95
    expr: histogram_quantile(0.95, rate(communication_thread_resolution_time_seconds_bucket[5m]))

  - record: communication:sla:compliance_5m
    expr: |
      1 - (
        rate(sla_breach_total[5m])
        /
        rate(communication_threads_total[5m])
      )

  - record: communication:email:success_rate
    expr: |
      rate(communication_messages_sent_total{channel="EMAIL"}[5m])
      /
      (rate(communication_messages_sent_total{channel="EMAIL"}[5m]) + rate(email_bounce_rate[5m]))

  - record: communication:sample:conversion_funnel
    expr: |
      sample_followups_sent_total
      * sample_followup_response_rate
      * sample_to_order_conversion_rate

  - record: communication:territory:composite_score
    expr: |
      (
        0.3 * (rate(communication_threads_total[1d]) / 100) +
        0.3 * sla_compliance_rate +
        0.2 * sample_followup_response_rate +
        0.2 * (1 - email_bounce_rate)
      ) by (territory)

# Custom Business KPIs
business_kpis:
  sales_efficiency:
    formula: |
      (sample_to_order_conversion_rate * avg_order_value)
      /
      (count(communication_threads_total) * avg_thread_cost)
    target: "> 5.0"
    unit: "ROI"

  customer_satisfaction:
    formula: |
      (
        sla_compliance_rate * 0.4 +
        (1 - email_bounce_rate) * 0.2 +
        (response_time_p95 < 3600) * 0.2 +
        multi_contact_threads_ratio * 0.2
      )
    target: "> 0.85"
    unit: "score"

  operational_efficiency:
    formula: |
      threads_resolved_per_day
      /
      (active_sales_reps * working_hours)
    target: "> 15"
    unit: "threads/rep/day"

  communication_quality:
    formula: |
      (
        messages_per_thread * message_relevance_score
      )
      /
      time_to_resolution
    target: "> 0.7"
    unit: "quality_score"