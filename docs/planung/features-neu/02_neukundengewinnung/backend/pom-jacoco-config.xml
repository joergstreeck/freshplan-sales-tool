<?xml version="1.0" encoding="UTF-8"?>
<!-- Add this configuration to the backend/pom.xml file -->
<!-- This enforces 80% code coverage for Module 02 -->

<build>
    <plugins>
        <!-- JaCoCo Maven Plugin for Code Coverage -->
        <plugin>
            <groupId>org.jacoco</groupId>
            <artifactId>jacoco-maven-plugin</artifactId>
            <version>0.8.11</version>
            <executions>
                <!-- Prepare agent for unit tests -->
                <execution>
                    <id>prepare-agent</id>
                    <goals>
                        <goal>prepare-agent</goal>
                    </goals>
                </execution>

                <!-- Prepare agent for integration tests -->
                <execution>
                    <id>prepare-agent-integration</id>
                    <goals>
                        <goal>prepare-agent-integration</goal>
                    </goals>
                </execution>

                <!-- Generate coverage report -->
                <execution>
                    <id>report</id>
                    <phase>verify</phase>
                    <goals>
                        <goal>report</goal>
                    </goals>
                </execution>

                <!-- Merge unit and integration test coverage -->
                <execution>
                    <id>merge</id>
                    <phase>verify</phase>
                    <goals>
                        <goal>merge</goal>
                    </goals>
                    <configuration>
                        <fileSets>
                            <fileSet>
                                <directory>${project.build.directory}</directory>
                                <includes>
                                    <include>jacoco.exec</include>
                                    <include>jacoco-it.exec</include>
                                </includes>
                            </fileSet>
                        </fileSets>
                        <destFile>${project.build.directory}/jacoco-merged.exec</destFile>
                    </configuration>
                </execution>

                <!-- Check coverage thresholds -->
                <execution>
                    <id>check</id>
                    <goals>
                        <goal>check</goal>
                    </goals>
                    <configuration>
                        <dataFile>${project.build.directory}/jacoco-merged.exec</dataFile>
                        <rules>
                            <!-- Module 02 specific coverage rules -->
                            <rule>
                                <element>BUNDLE</element>
                                <limits>
                                    <!-- 80% line coverage required -->
                                    <limit>
                                        <counter>LINE</counter>
                                        <value>COVEREDRATIO</value>
                                        <minimum>0.80</minimum>
                                    </limit>
                                    <!-- 80% branch coverage required -->
                                    <limit>
                                        <counter>BRANCH</counter>
                                        <value>COVEREDRATIO</value>
                                        <minimum>0.80</minimum>
                                    </limit>
                                </limits>
                            </rule>

                            <!-- Package-level rules for critical components -->
                            <rule>
                                <element>PACKAGE</element>
                                <includes>
                                    <include>de.freshplan.leads.repo</include>
                                    <include>de.freshplan.leads.service</include>
                                    <include>de.freshplan.security</include>
                                </includes>
                                <limits>
                                    <!-- Critical packages need 85% coverage -->
                                    <limit>
                                        <counter>LINE</counter>
                                        <value>COVEREDRATIO</value>
                                        <minimum>0.85</minimum>
                                    </limit>
                                </limits>
                            </rule>

                            <!-- Class-level rules -->
                            <rule>
                                <element>CLASS</element>
                                <excludes>
                                    <!-- Exclude generated code -->
                                    <exclude>*_.class</exclude>
                                    <!-- Exclude DTOs -->
                                    <exclude>de.freshplan.leads.dto.*</exclude>
                                    <!-- Exclude entities -->
                                    <exclude>de.freshplan.leads.domain.*Entity</exclude>
                                </excludes>
                                <limits>
                                    <!-- Each class should have at least 75% coverage -->
                                    <limit>
                                        <counter>LINE</counter>
                                        <value>COVEREDRATIO</value>
                                        <minimum>0.75</minimum>
                                    </limit>
                                </limits>
                            </rule>
                        </rules>
                    </configuration>
                </execution>
            </executions>
        </plugin>

        <!-- Surefire for unit tests -->
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-surefire-plugin</artifactId>
            <version>3.1.2</version>
            <configuration>
                <systemPropertyVariables>
                    <jacoco.destFile>${project.build.directory}/jacoco.exec</jacoco.destFile>
                    <java.util.logging.manager>org.jboss.logmanager.LogManager</java.util.logging.manager>
                </systemPropertyVariables>
                <includes>
                    <include>**/*Test.java</include>
                    <include>**/*Tests.java</include>
                </includes>
                <excludes>
                    <exclude>**/*IntegrationTest.java</exclude>
                    <exclude>**/*IT.java</exclude>
                </excludes>
            </configuration>
        </plugin>

        <!-- Failsafe for integration tests -->
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-failsafe-plugin</artifactId>
            <version>3.1.2</version>
            <configuration>
                <systemPropertyVariables>
                    <jacoco.destFile>${project.build.directory}/jacoco-it.exec</jacoco.destFile>
                    <java.util.logging.manager>org.jboss.logmanager.LogManager</java.util.logging.manager>
                </systemPropertyVariables>
                <includes>
                    <include>**/*IntegrationTest.java</include>
                    <include>**/*IT.java</include>
                </includes>
            </configuration>
            <executions>
                <execution>
                    <goals>
                        <goal>integration-test</goal>
                        <goal>verify</goal>
                    </goals>
                </execution>
            </executions>
        </plugin>
    </plugins>
</build>

<!-- Reporting configuration -->
<reporting>
    <plugins>
        <plugin>
            <groupId>org.jacoco</groupId>
            <artifactId>jacoco-maven-plugin</artifactId>
            <version>0.8.11</version>
            <reportSets>
                <reportSet>
                    <reports>
                        <report>report</report>
                    </reports>
                </reportSet>
            </reportSets>
        </plugin>
    </plugins>
</reporting>

<!-- Properties for coverage thresholds -->
<properties>
    <!-- Coverage thresholds can be overridden via command line -->
    <jacoco.rule.element>BUNDLE</jacoco.rule.element>
    <jacoco.rule.counter>LINE</jacoco.rule.counter>
    <jacoco.rule.value>COVEREDRATIO</jacoco.rule.value>
    <jacoco.rule.minimum>0.80</jacoco.rule.minimum>

    <!-- Skip coverage check in dev mode -->
    <jacoco.skip>false</jacoco.skip>
</properties>