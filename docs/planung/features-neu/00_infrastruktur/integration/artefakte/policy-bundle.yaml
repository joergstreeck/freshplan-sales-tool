_format_version: "3.0"
_transform: true
_info:
  title: FreshPlan Gateway Policy Bundle (Kong)
  version: 1.0

services:
  - name: api-backend
    url: http://backend:8080
    routes:
      - name: api-route
        paths: ["/api"]
        methods: ["GET","POST","PUT","PATCH","DELETE"]
        strip_path: false
        plugins:
          # OIDC Auth (Keycloak) – ensure plugin installed/configured
          - name: openid-connect
            config:
              issuer: https://keycloak/auth/realms/freshplan
              client_id: freshplan-gateway
              scopes: ["openid","profile","email","roles"]
              auth_methods: ["bearer"]
              introspection_endpoint_auth_method: "client_secret_post"
          # CORS
          - name: cors
            config:
              origins: ["https://app.freshplan.example"]
              methods: ["GET","POST","PUT","PATCH","DELETE","OPTIONS"]
              headers: ["Authorization","Content-Type","If-Match","If-None-Match","Idempotency-Key","X-Correlation-Id","X-Tenant-Id","X-Org-Id"]
              exposed_headers: ["ETag"]
              credentials: true
              max_age: 86400
          # Global Rate Limiting (per tenant via header) – requires rate-limiting-advanced plugin
          - name: rate-limiting-advanced
            config:
              identifier: header
              header_name: "x-tenant-id"
              limit:
                - 2000
              window_size:
                - 60
              sync_rate: -1
              strategy: redis
              redis:
                host: redis
                port: 6379
          # Require Headers for Writes (Idempotency-Key & X-Correlation-Id) – using pre-function (Lua) plugin
          - name: pre-function
            config:
              access:
                - |
                  local method = kong.request.get_method()
                  local function is_write(m) return m=="POST" or m=="PUT" or m=="PATCH" or m=="DELETE" end
                  if is_write(method) then
                    local idem = kong.request.get_header("Idempotency-Key")
                    if not idem or idem == "" then
                      return kong.response.exit(400, {title="Idempotency Key Required", status=400, detail="Provide Idempotency-Key for write requests"})
                    end
                    local ifmatch = kong.request.get_header("If-Match")
                    if (method=="PUT" or method=="PATCH") and (not ifmatch or ifmatch=="") then
                      return kong.response.exit(428, {title="Precondition Required", status=428, detail="If-Match header required for update operations"})
                    end
                  end
                  local corr = kong.request.get_header("X-Correlation-Id")
                  if not corr or corr=="" then
                    -- generate if absent
                    kong.service.request.set_header("X-Correlation-Id", kong.uuid())
                  end
          # Logging
          - name: file-log
            config:
              path: /var/log/kong/freshplan-access.log
              reopen: true

# Policy templates by tag (apply per route/service as needed)
# Tag your routes with 'read-heavy', 'write-heavy', 'critical' and deploy via deck/kustomize overlays.
