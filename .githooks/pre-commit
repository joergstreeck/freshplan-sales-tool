#!/usr/bin/env sh

# ============================================================================
# Husky Pre-Commit Hook: Multi-Stage Quality Gate
# ============================================================================
#
# PRÃœFUNG 1: Design System Compliance (BLOCKIEREND)
# PRÃœFUNG 2: Server-Driven Architecture Parity (BLOCKIEREND)
# PRÃœFUNG 2.3: Enum Seed Data Case Validation (BLOCKIEREND) - NEW Sprint 2.1.7.7
# PRÃœFUNG 2.5: Enum-Rendering-Parity (BLOCKIEREND) - Sprint 2.1.7.7
# PRÃœFUNG 2.6: Field Type Architecture (BLOCKIEREND) - Sprint 2.1.7.7
# PRÃœFUNG 3: Server-Driven Sections Architecture (BLOCKIEREND)
# PRÃœFUNG 4: Backend Code Formatting (Spotless Auto-Format)
# PRÃœFUNG 5: Backend Compilation Check (BLOCKIEREND) - Sprint 2.1.7.7
# PRÃœFUNG 6: Frontend Code Formatting (Lint-Staged Auto-Format)
# PRÃœFUNG 7: Dependency Cycles Check (BLOCKIEREND) - Sprint 2.1.7.7
# PRÃœFUNG 8: Test Cleanup - @AfterEach Validation (Check-Only) - Sprint 2.1.7.7
# PRÃœFUNG 9: OpenAPI Type Sync Check (INFO-ONLY) - Sprint 2.1.7.7 OpenAPI Contract-First
# PRÃœFUNG 10: fieldCatalog.json Removal Guard (BLOCKIEREND) - Sprint 2.1.7.x
#
# ============================================================================

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ============================================================================
# PRÃœFUNG 1: Design System Compliance Check
# ============================================================================

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ¨ Design System Compliance Check${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Run Design System Check (Python script)
if ! python3 ./scripts/check-design-system.py; then
  echo ""
  echo -e "${RED}ğŸš« PRE-COMMIT HOOK: Design System Violations detected!${NC}"
  echo ""
  echo -e "${YELLOW}   Commit BLOCKIERT. Bitte behebe die CRITICAL violations.${NC}"
  echo ""
  echo -e "${YELLOW}   Zum Ãœberspringen (NOT RECOMMENDED): git commit --no-verify${NC}"
  echo ""
  exit 1
fi

echo ""
echo -e "${GREEN}âœ… Design System Compliance: PASSED${NC}"
echo ""

# ============================================================================
# PRÃœFUNG 2: Server-Driven Architecture Parity
# ============================================================================

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ”’ Server-Driven Architecture Parity Check${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Run Server-Driven Parity Check (Python script)
if ! python3 ./scripts/check-server-driven-parity.py; then
  echo ""
  echo -e "${RED}ğŸš« PRE-COMMIT HOOK: Server-Driven Parity Violations detected!${NC}"
  echo ""
  echo -e "${YELLOW}   Commit BLOCKIERT. Bitte behebe die Violations:${NC}"
  echo ""
  echo -e "   ${YELLOW}â€¢ STUFE 1: Alle Schema-Felder MÃœSSEN in Entity existieren${NC}"
  echo -e "   ${YELLOW}â€¢ STUFE 2: ENUM-Felder MÃœSSEN enumSource haben (kein hardcoded options)${NC}"
  echo ""
  echo -e "${YELLOW}   Zum Ãœberspringen (NOT RECOMMENDED): git commit --no-verify${NC}"
  echo ""
  exit 1
fi

echo ""
echo -e "${GREEN}âœ… Server-Driven Parity: PASSED${NC}"
echo ""

# ============================================================================
# PRÃœFUNG 2.3: Enum Value Case Validation in Seed Data
# ============================================================================

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ”¢ Enum Seed Data Case Validation${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Run Enum Seed Data Case Check (Python script)
if ! python3 ./scripts/check-enum-seed-data-case.py; then
  echo ""
  echo -e "${RED}ğŸš« PRE-COMMIT HOOK: Enum Value Case Violations detected!${NC}"
  echo ""
  echo -e "${YELLOW}   Commit BLOCKIERT. Bitte behebe die Violations:${NC}"
  echo ""
  echo -e "   ${YELLOW}â€¢ ALLE Enum-Werte in V900*.sql MÃœSSEN UPPERCASE sein${NC}"
  echo -e "   ${YELLOW}â€¢ Beispiel: 'GmbH' â†’ 'GMBH', 'Frau' â†’ 'FRAU'${NC}"
  echo ""
  echo -e "${YELLOW}   Zum Ãœberspringen (NOT RECOMMENDED): git commit --no-verify${NC}"
  echo ""
  exit 1
fi

echo ""
echo -e "${GREEN}âœ… Enum Seed Data Case: PASSED${NC}"
echo ""

# ============================================================================
# PRÃœFUNG 2.5: Enum-Rendering-Parity Check (Context-Aware)
# ============================================================================

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ” Enum-Rendering-Parity Check (Context-Aware)${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Run Enum-Rendering-Parity Check (Python script)
if ! python3 ./scripts/check-enum-rendering-parity.py; then
  echo ""
  echo -e "${RED}ğŸš« PRE-COMMIT HOOK: Enum-Rendering-Parity Violations detected!${NC}"
  echo ""
  echo -e "${YELLOW}   Commit BLOCKIERT. Bitte behebe die RAW Enum-Rendering Violations:${NC}"
  echo ""
  echo -e "   ${YELLOW}â€¢ ZERO TOLERANCE: Backend = Single Source of Truth fÃ¼r ALLE Enum-Werte${NC}"
  echo -e "   ${YELLOW}â€¢ LÃ¶sung: Nutze useEnumOptions() + Label-Lookup${NC}"
  echo -e "   ${YELLOW}â€¢ Beispiel: decisionLevelLabels[contact.decisionLevel]${NC}"
  echo ""
  echo -e "${YELLOW}   Zum Ãœberspringen (NOT RECOMMENDED): git commit --no-verify${NC}"
  echo ""
  exit 1
fi

echo ""
echo -e "${GREEN}âœ… Enum-Rendering-Parity: PASSED${NC}"
echo ""

# ============================================================================
# PRÃœFUNG 2.6: Field Type Architecture Check
# ============================================================================

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ”§ Field Type Architecture Check${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Run Field Type Architecture Check (Python script)
if ! python3 ./scripts/check-field-type-architecture.py; then
  echo ""
  echo -e "${RED}ğŸš« PRE-COMMIT HOOK: Field Type Architecture Violations detected!${NC}"
  echo ""
  echo -e "${YELLOW}   Commit BLOCKIERT. Bitte behebe die Violations:${NC}"
  echo ""
  echo -e "   ${YELLOW}â€¢ Verwende field.type statt field.fieldType (Server-Driven Property)${NC}"
  echo -e "   ${YELLOW}â€¢ Field Types MÃœSSEN UPPERCASE sein: 'TEXT', 'ENUM', 'NUMBER' (nicht 'text', 'enum')${NC}"
  echo -e "   ${YELLOW}â€¢ Referenz: frontend/src/types/customer-schema.ts â†’ FieldType enum${NC}"
  echo ""
  echo -e "${YELLOW}   Zum Ãœberspringen (NOT RECOMMENDED): git commit --no-verify${NC}"
  echo ""
  exit 1
fi

echo ""
echo -e "${GREEN}âœ… Field Type Architecture: PASSED${NC}"
echo ""

# ============================================================================
# PRÃœFUNG 3: Server-Driven Sections Architecture
# ============================================================================

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ—ï¸  Server-Driven Sections Architecture Check${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Run Server-Driven Sections Check (Bash script in backend/)
if [ -f "backend/scripts/check-server-driven-sections.sh" ]; then
  if ! (cd backend && ./scripts/check-server-driven-sections.sh); then
    echo ""
    echo -e "${RED}ğŸš« PRE-COMMIT HOOK: Server-Driven Sections Violations detected!${NC}"
    echo ""
    echo -e "${YELLOW}   Commit BLOCKIERT. Bitte behebe die Violations:${NC}"
    echo ""
    echo -e "   ${YELLOW}â€¢ STUFE 1: Wizard-Fields MÃœSSEN wizardSectionId + wizardSectionTitle haben${NC}"
    echo -e "   ${YELLOW}â€¢ STUFE 2: Frontend darf KEINE hardcodierten Section-Strukturen haben${NC}"
    echo ""
    echo -e "${YELLOW}   Zum Ãœberspringen (NOT RECOMMENDED): git commit --no-verify${NC}"
    echo ""
    exit 1
  fi

  echo ""
  echo -e "${GREEN}âœ… Server-Driven Sections: PASSED${NC}"
  echo ""
else
  echo ""
  echo -e "${YELLOW}âš ï¸  Server-Driven Sections Check: Script not found (skipped)${NC}"
  echo ""
fi

# ============================================================================
# PRÃœFUNG 4: Backend Code Formatting (Spotless Auto-Format)
# ============================================================================

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ§¹ Backend Code Formatting (Spotless)${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Check if any backend files were changed
BACKEND_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "^backend/" || true)

if [ -n "$BACKEND_FILES" ]; then
  echo "ğŸ“ Backend files changed, applying Spotless formatting..."
  echo ""

  # Apply Spotless formatting
  if ! (cd backend && ./mvnw spotless:apply -q); then
    echo ""
    echo -e "${RED}ğŸš« PRE-COMMIT HOOK: Spotless formatting failed!${NC}"
    echo ""
    echo -e "${YELLOW}   Commit BLOCKIERT. Bitte prÃ¼fe die Spotless-Konfiguration.${NC}"
    echo ""
    exit 1
  fi

  # Add formatted files back to staging
  echo "âœ¨ Re-staging formatted backend files..."
  git add backend/

  echo ""
  echo -e "${GREEN}âœ… Backend Code Formatting: APPLIED${NC}"
  echo ""
else
  echo "â­ï¸  No backend files changed, skipping Spotless"
  echo ""
fi

# ============================================================================
# PRÃœFUNG 5: Backend Compilation Check
# ============================================================================

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ”¨ Backend Compilation Check${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Check if any backend files were changed (reuse variable from PRÃœFUNG 4)
BACKEND_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "^backend/" || true)

if [ -n "$BACKEND_FILES" ]; then
  echo "ğŸ”¨ Backend files changed, checking compilation..."
  echo ""

  # Run Maven compile (quiet mode)
  if ! (cd backend && ./mvnw -B compile -q -DskipTests); then
    echo ""
    echo -e "${RED}ğŸš« PRE-COMMIT HOOK: Backend Compilation FAILED!${NC}"
    echo ""
    echo -e "${YELLOW}   Commit BLOCKIERT. Bitte behebe die Compilation-Fehler:${NC}"
    echo ""
    echo -e "   ${YELLOW}â€¢ PrÃ¼fe Java-Syntax-Fehler${NC}"
    echo -e "   ${YELLOW}â€¢ PrÃ¼fe fehlende Imports${NC}"
    echo -e "   ${YELLOW}â€¢ PrÃ¼fe Type-Errors${NC}"
    echo ""
    echo -e "${YELLOW}   Zum Ãœberspringen (NOT RECOMMENDED): git commit --no-verify${NC}"
    echo ""
    exit 1
  fi

  echo ""
  echo -e "${GREEN}âœ… Backend Compilation: PASSED${NC}"
  echo ""
else
  echo "â­ï¸  No backend files changed, skipping compilation check"
  echo ""
fi

# ============================================================================
# PRÃœFUNG 6: Frontend Code Formatting (Lint-Staged)
# ============================================================================

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ’… Frontend Code Formatting (lint-staged)${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Frontend lint-staged
if [ -d "frontend" ]; then
  if ! (cd frontend && npm run lint-staged); then
    echo ""
    echo -e "${RED}ğŸš« PRE-COMMIT HOOK: Lint-Staged failed!${NC}"
    echo ""
    echo -e "${YELLOW}   Commit BLOCKIERT. Bitte behebe die Linting-Fehler.${NC}"
    echo ""
    exit 1
  fi

  echo ""
  echo -e "${GREEN}âœ… Frontend Lint-Staged: PASSED${NC}"
  echo ""
fi

# ============================================================================
# PRÃœFUNG 7: Dependency Cycles Check
# ============================================================================

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ”„ Dependency Cycles Check${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Check if any backend files were changed
BACKEND_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "^backend/.*\.java$" || true)

if [ -n "$BACKEND_FILES" ]; then
  echo "ğŸ” Backend Java files changed, checking for circular dependencies..."
  echo ""

  # Run Dependency Cycles Check (Python script)
  if ! python3 ./scripts/check-dependency-cycles.py; then
    echo ""
    echo -e "${RED}ğŸš« PRE-COMMIT HOOK: Dependency Cycles detected!${NC}"
    echo ""
    echo -e "${YELLOW}   Commit BLOCKIERT. Bitte behebe die zirkulÃ¤ren AbhÃ¤ngigkeiten:${NC}"
    echo ""
    echo -e "   ${YELLOW}â€¢ LÃ¶sung 1: Interface Abstraction (Dependency Inversion Principle)${NC}"
    echo -e "   ${YELLOW}â€¢ LÃ¶sung 2: Shared Package fÃ¼r gemeinsame Klassen${NC}"
    echo -e "   ${YELLOW}â€¢ LÃ¶sung 3: Dependency Richtung umkehren${NC}"
    echo ""
    echo -e "${YELLOW}   Details siehe oben im Check-Output.${NC}"
    echo ""
    echo -e "${YELLOW}   Zum Ãœberspringen (NOT RECOMMENDED): git commit --no-verify${NC}"
    echo ""
    exit 1
  fi

  echo ""
  echo -e "${GREEN}âœ… Dependency Cycles Check: PASSED (No cycles detected)${NC}"
  echo ""
else
  echo "â­ï¸  No backend Java files changed, skipping dependency cycles check"
  echo ""
fi

# ============================================================================
# PRÃœFUNG 8: Test Cleanup - @AfterEach Validation
# ============================================================================

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ§ª Test Cleanup - @AfterEach Validation${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Check if any backend test files were changed
BACKEND_TEST_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "^backend/src/test/.*\.java$" || true)

if [ -n "$BACKEND_TEST_FILES" ]; then
  echo "ğŸ§ª Backend test files changed, validating @AfterEach cleanup..."
  echo ""

  # Run Test Cleanup Validation (Check-Only)
  if ! python3 ./backend/scripts/check-test-cleanup.py; then
    echo ""
    echo -e "${RED}ğŸš« PRE-COMMIT HOOK: Test Cleanup Validation failed!${NC}"
    echo ""
    echo -e "${YELLOW}   Commit BLOCKIERT. Tests ohne @AfterEach cleanup gefunden.${NC}"
    echo -e "${YELLOW}   Bitte fÃ¼ge @AfterEach cleanup zu den betroffenen Tests hinzu.${NC}"
    echo ""
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BLUE}ğŸ“š CLEANUP BEISPIEL (aus BranchServiceTest.java):${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "@AfterEach"
    echo "@Transactional"
    echo "void cleanup() {"
    echo "  // Step 1: Delete child entities (foreign key constraints!)"
    echo "  entityManager.createNativeQuery("
    echo "    \"DELETE FROM customer_timeline_events WHERE customer_id IN \" +"
    echo "    \"(SELECT id FROM customers WHERE customer_number LIKE 'TEST-%')\")"
    echo "    .executeUpdate();"
    echo ""
    echo "  // Step 2: Delete parent entities"
    echo "  customerRepository.delete(\"customerNumber LIKE 'TEST-%'\");"
    echo "}"
    echo ""
    echo -e "${BLUE}Wichtig:${NC}"
    echo "  â€¢ @Transactional ist PFLICHT"
    echo "  â€¢ EntityManager mit @Inject einbinden"
    echo "  â€¢ CHILD-Entities ZUERST lÃ¶schen (Foreign Keys!)"
    echo "  â€¢ Pattern-Matching (TEST-%, KD-%) fÃ¼r Test-Daten"
    echo ""
    echo -e "${BLUE}Weitere Beispiele:${NC}"
    echo "  â€¢ backend/src/test/java/de/freshplan/domain/customer/service/BranchServiceTest.java"
    echo "  â€¢ backend/src/test/java/de/freshplan/domain/customer/service/timeline/query/TimelineQueryServiceTest.java"
    echo ""
    exit 1
  fi

  echo ""
  echo -e "${GREEN}âœ… Test Cleanup: All tests have proper @AfterEach cleanup${NC}"
  echo ""
else
  echo "â­ï¸  No backend test files changed, skipping test cleanup validation"
  echo ""
fi

# ============================================================================
# PRÃœFUNG 9: OpenAPI Type Sync Check (BLOCKIEREND)
# ============================================================================

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ”„ OpenAPI Type Sync Check${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Check if backend DTO files were changed (*Request.java, *Response.java)
BACKEND_DTO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E "backend/src/main/java/.*(Request|Response)\.java$" || true)

if [ -n "$BACKEND_DTO_FILES" ]; then
  echo -e "${YELLOW}âš ï¸  Backend DTO files wurden geÃ¤ndert:${NC}"
  echo "$BACKEND_DTO_FILES" | sed 's/^/   â€¢ /'
  echo ""

  # Check if generated types directory exists and is up-to-date
  GENERATED_DIR="frontend/src/api/generated"

  if [ ! -d "$GENERATED_DIR" ]; then
    echo ""
    echo -e "${RED}âŒ COMMIT BLOCKIERT: Generierte TypeScript-Types fehlen!${NC}"
    echo ""
    echo -e "${YELLOW}   Backend DTOs wurden geÃ¤ndert, aber frontend/src/api/generated/ existiert nicht.${NC}"
    echo ""
    echo -e "${YELLOW}   Bitte TypeScript-Types generieren:${NC}"
    echo -e "   ${BLUE}1. Backend starten:${NC}"
    echo -e "      cd backend && ./mvnw quarkus:dev"
    echo ""
    echo -e "   ${BLUE}2. Frontend-Types generieren:${NC}"
    echo -e "      cd frontend && npm run generate-api"
    echo ""
    echo -e "   ${BLUE}3. Generierte Types committen:${NC}"
    echo -e "      git add frontend/src/api/generated/"
    echo -e "      git commit"
    echo ""
    echo -e "${YELLOW}   Zum Ãœberspringen (NOT RECOMMENDED): git commit --no-verify${NC}"
    echo ""
    exit 1
  fi

  # Check if generated files are staged
  STAGED_GENERATED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E "^frontend/src/api/generated/" || true)

  if [ -z "$STAGED_GENERATED_FILES" ]; then
    echo ""
    echo -e "${RED}âŒ COMMIT BLOCKIERT: Generierte TypeScript-Types nicht ge-staged!${NC}"
    echo ""
    echo -e "${YELLOW}   Backend DTOs wurden geÃ¤ndert, aber generierte Types wurden nicht ge-staged.${NC}"
    echo ""
    echo -e "${YELLOW}   Bitte TypeScript-Types aktualisieren und stagen:${NC}"
    echo -e "   ${BLUE}1. Backend starten (falls nicht gestartet):${NC}"
    echo -e "      cd backend && ./mvnw quarkus:dev"
    echo ""
    echo -e "   ${BLUE}2. Frontend-Types neu generieren:${NC}"
    echo -e "      cd frontend && npm run generate-api"
    echo ""
    echo -e "   ${BLUE}3. Generierte Types stagen:${NC}"
    echo -e "      git add frontend/src/api/generated/"
    echo -e "      git commit"
    echo ""
    echo -e "${YELLOW}   Hinweis: Wenn Types bereits aktuell sind, bitte trotzdem stagen.${NC}"
    echo -e "${YELLOW}   Zum Ãœberspringen (NOT RECOMMENDED): git commit --no-verify${NC}"
    echo ""
    exit 1
  fi

  echo ""
  echo -e "${GREEN}âœ… Generierte TypeScript-Types sind ge-staged.${NC}"
  echo -e "${GREEN}   Contract-First Development: Backend ist Single Source of Truth.${NC}"
  echo ""
else
  echo "â­ï¸  No backend DTO files changed, OpenAPI types should be in sync"
  echo ""
fi

# ============================================================================
# PRÃœFUNG 10: fieldCatalog.json Removal Guard
# ============================================================================

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ—‘ï¸  fieldCatalog.json Removal Guard${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Run fieldCatalog.json Removal Guard (Python script)
if ! python3 ./scripts/check-fieldcatalog-removed.py; then
  echo ""
  echo -e "${RED}ğŸš« PRE-COMMIT HOOK: fieldCatalog.json Migration Regression detected!${NC}"
  echo ""
  echo -e "${YELLOW}   Commit BLOCKIERT. Server-Driven UI Migration wurde rÃ¼ckgÃ¤ngig gemacht!${NC}"
  echo ""
  echo -e "   ${YELLOW}â€¢ fieldCatalog.json wurde in Sprint 2.1.7.x gelÃ¶scht${NC}"
  echo -e "   ${YELLOW}â€¢ Backend ist Single Source of Truth fÃ¼r Field Definitions${NC}"
  echo -e "   ${YELLOW}â€¢ Use useCustomerSchema or useLocationServiceSchema instead${NC}"
  echo ""
  echo -e "${YELLOW}   Migration Guide:${NC}"
  echo -e "   ${YELLOW}   /docs/planung/claude-work/MIGRATION_PLAN_fieldCatalog_removal.md${NC}"
  echo ""
  echo -e "${YELLOW}   Zum Ãœberspringen (NOT RECOMMENDED): git commit --no-verify${NC}"
  echo ""
  exit 1
fi

echo ""
echo -e "${GREEN}âœ… fieldCatalog.json Removal Guard: PASSED${NC}"
echo ""

# ============================================================================
# SUCCESS
# ============================================================================

echo ""
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ… All Pre-Commit Checks PASSED${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

exit 0
