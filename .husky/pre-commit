#!/usr/bin/env sh

# ============================================================================
# Husky Pre-Commit Hook: Multi-Stage Quality Gate
# ============================================================================
#
# PRÃœFUNG 1: Design System Compliance (BLOCKIEREND)
# PRÃœFUNG 2: Server-Driven Architecture Parity (BLOCKIEREND)
# PRÃœFUNG 3: Server-Driven Sections Architecture (BLOCKIEREND)
# PRÃœFUNG 4: Backend Code Formatting (Spotless Auto-Format)
# PRÃœFUNG 5: Frontend Code Formatting (Lint-Staged Auto-Format)
#
# ============================================================================

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ============================================================================
# PRÃœFUNG 1: Design System Compliance Check
# ============================================================================

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ¨ Design System Compliance Check${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Run Design System Check (Python script)
if ! python3 ./scripts/check-design-system.py; then
  echo ""
  echo -e "${RED}ğŸš« PRE-COMMIT HOOK: Design System Violations detected!${NC}"
  echo ""
  echo -e "${YELLOW}   Commit BLOCKIERT. Bitte behebe die CRITICAL violations.${NC}"
  echo ""
  echo -e "${YELLOW}   Zum Ãœberspringen (NOT RECOMMENDED): git commit --no-verify${NC}"
  echo ""
  exit 1
fi

echo ""
echo -e "${GREEN}âœ… Design System Compliance: PASSED${NC}"
echo ""

# ============================================================================
# PRÃœFUNG 2: Server-Driven Architecture Parity
# ============================================================================

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ”’ Server-Driven Architecture Parity Check${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Run Server-Driven Parity Check (Python script)
if ! python3 ./scripts/check-server-driven-parity.py; then
  echo ""
  echo -e "${RED}ğŸš« PRE-COMMIT HOOK: Server-Driven Parity Violations detected!${NC}"
  echo ""
  echo -e "${YELLOW}   Commit BLOCKIERT. Bitte behebe die Violations:${NC}"
  echo ""
  echo -e "   ${YELLOW}â€¢ STUFE 1: Alle Schema-Felder MÃœSSEN in Entity existieren${NC}"
  echo -e "   ${YELLOW}â€¢ STUFE 2: ENUM-Felder MÃœSSEN enumSource haben (kein hardcoded options)${NC}"
  echo ""
  echo -e "${YELLOW}   Zum Ãœberspringen (NOT RECOMMENDED): git commit --no-verify${NC}"
  echo ""
  exit 1
fi

echo ""
echo -e "${GREEN}âœ… Server-Driven Parity: PASSED${NC}"
echo ""

# ============================================================================
# PRÃœFUNG 3: Server-Driven Sections Architecture
# ============================================================================

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ—ï¸  Server-Driven Sections Architecture Check${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Run Server-Driven Sections Check (Bash script in backend/)
if [ -f "backend/scripts/check-server-driven-sections.sh" ]; then
  if ! (cd backend && ./scripts/check-server-driven-sections.sh); then
    echo ""
    echo -e "${RED}ğŸš« PRE-COMMIT HOOK: Server-Driven Sections Violations detected!${NC}"
    echo ""
    echo -e "${YELLOW}   Commit BLOCKIERT. Bitte behebe die Violations:${NC}"
    echo ""
    echo -e "   ${YELLOW}â€¢ STUFE 1: Wizard-Fields MÃœSSEN wizardSectionId + wizardSectionTitle haben${NC}"
    echo -e "   ${YELLOW}â€¢ STUFE 2: Frontend darf KEINE hardcodierten Section-Strukturen haben${NC}"
    echo ""
    echo -e "${YELLOW}   Zum Ãœberspringen (NOT RECOMMENDED): git commit --no-verify${NC}"
    echo ""
    exit 1
  fi

  echo ""
  echo -e "${GREEN}âœ… Server-Driven Sections: PASSED${NC}"
  echo ""
else
  echo ""
  echo -e "${YELLOW}âš ï¸  Server-Driven Sections Check: Script not found (skipped)${NC}"
  echo ""
fi

# ============================================================================
# PRÃœFUNG 4: Backend Code Formatting (Spotless Auto-Format)
# ============================================================================

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ§¹ Backend Code Formatting (Spotless)${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Check if any backend files were changed
BACKEND_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "^backend/" || true)

if [ -n "$BACKEND_FILES" ]; then
  echo "ğŸ“ Backend files changed, applying Spotless formatting..."
  echo ""

  # Apply Spotless formatting
  if ! (cd backend && ./mvnw spotless:apply -q); then
    echo ""
    echo -e "${RED}ğŸš« PRE-COMMIT HOOK: Spotless formatting failed!${NC}"
    echo ""
    echo -e "${YELLOW}   Commit BLOCKIERT. Bitte prÃ¼fe die Spotless-Konfiguration.${NC}"
    echo ""
    exit 1
  fi

  # Add formatted files back to staging
  echo "âœ¨ Re-staging formatted backend files..."
  git add backend/

  echo ""
  echo -e "${GREEN}âœ… Backend Code Formatting: APPLIED${NC}"
  echo ""
else
  echo "â­ï¸  No backend files changed, skipping Spotless"
  echo ""
fi

# ============================================================================
# PRÃœFUNG 5: Frontend Code Formatting (Lint-Staged)
# ============================================================================

echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ’… Frontend Code Formatting (lint-staged)${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Frontend lint-staged
if [ -d "frontend" ]; then
  if ! (cd frontend && npm run lint-staged); then
    echo ""
    echo -e "${RED}ğŸš« PRE-COMMIT HOOK: Lint-Staged failed!${NC}"
    echo ""
    echo -e "${YELLOW}   Commit BLOCKIERT. Bitte behebe die Linting-Fehler.${NC}"
    echo ""
    exit 1
  fi

  echo ""
  echo -e "${GREEN}âœ… Frontend Lint-Staged: PASSED${NC}"
  echo ""
fi

# ============================================================================
# SUCCESS
# ============================================================================

echo ""
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ… All Pre-Commit Checks PASSED${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

exit 0
