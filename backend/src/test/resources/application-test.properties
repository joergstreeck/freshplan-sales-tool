# Test-specific configuration - HART AUF CI-DB VERDRAHTET

# Test-Port Configuration - Port 0 = random free port
quarkus.http.test-port=0
quarkus.http.test-ssl-port=0

quarkus.datasource.db-kind=postgresql
quarkus.datasource.username=freshplan
quarkus.datasource.password=freshplan

# CRITICAL: Disable DevServices - MUST USE CI DB
quarkus.datasource.devservices.enabled=false

# HART VERDRAHTETE CI-DB URL - keine anderen Sources erlaubt
quarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5432/freshplan

# Connection pool settings for stability
quarkus.datasource.jdbc.min-size=1
quarkus.datasource.jdbc.max-size=5
quarkus.datasource.jdbc.acquisition-timeout=30
quarkus.datasource.jdbc.leak-detection-interval=30
quarkus.datasource.jdbc.idle-removal-interval=60
quarkus.datasource.jdbc.max-lifetime=600
quarkus.datasource.jdbc.validation-query-sql=SELECT 1

# Flyway configuration for test
quarkus.flyway.migrate-at-start=true
# CRITICAL: Enable clean to ensure fresh DB state in tests
quarkus.flyway.clean-disabled=false
quarkus.flyway.clean-at-start=true
quarkus.flyway.repair-at-start=true
# Nur noch Standard-Migrationen - keine SEED-Daten mehr
quarkus.flyway.locations=classpath:db/migration
# No Hibernate schema generation - let Flyway handle everything
quarkus.hibernate-orm.database.generation=none

# Transaction configuration for tests
# Increase timeout to prevent Transaction Reaper warnings
quarkus.transaction-manager.default-transaction-timeout=120s
# Disable transaction reaper warnings in tests
quarkus.log.category."com.arjuna.ats.arjuna".level=ERROR

# Logging
quarkus.log.level=INFO
quarkus.log.category."de.freshplan".level=DEBUG
# Enhanced Flyway logging to see callbacks
quarkus.log.category."org.flywaydb".level=DEBUG
quarkus.log.category."org.flywaydb.core.internal.callback".level=DEBUG

# Security configuration for tests
# Disable SecurityContextFilter for service tests without HTTP
app.security.context-filter.enabled=false

# SQL Debug Logging - CRITICAL f√ºr Test-Debugging
quarkus.hibernate-orm.log.sql=true
quarkus.hibernate-orm.log.bind-parameters=true
quarkus.log.category."org.hibernate.SQL".level=DEBUG
quarkus.log.category."org.hibernate.type.descriptor.sql.BasicBinder".level=TRACE
quarkus.log.category."io.quarkus.agroal".level=DEBUG
quarkus.log.category."io.agroal.pool".level=DEBUG

# Flyway Schema explizit setzen
quarkus.flyway.schemas=public

# Lead Module Configuration for Tests
freshplan.followup.enabled=true
freshplan.lead.auto-enrich=false
freshplan.lead.duplicate-check=true

# Event Listeners - komplett deaktiviert in Tests
freshplan.events.listener.enabled=false
freshplan.modules.leads.events.enabled=false
freshplan.modules.cross.events.enabled=false