# Test configuration - PostgreSQL via Testcontainers
quarkus.datasource.db-kind=postgresql

# DevServices for real PostgreSQL with extensions
quarkus.datasource.devservices.enabled=true
quarkus.datasource.devservices.image-name=postgres:15-alpine
quarkus.datasource.devservices.db-name=freshplan-test
quarkus.datasource.devservices.username=test
quarkus.datasource.devservices.password=test

# Flyway configuration for deterministic test runs
quarkus.flyway.migrate-at-start=true
quarkus.flyway.baseline-on-migrate=true
# Clean database for each test run (deterministic)
quarkus.flyway.clean-at-start=true
# Allow out-of-order migrations for flexibility
quarkus.flyway.out-of-order=true
# Repair schema history if needed
quarkus.flyway.repair-at-start=false
# Include both versioned and repeatable migrations
quarkus.flyway.locations=classpath:db/migration

# Hibernate - let Flyway handle schema
quarkus.hibernate-orm.database.generation=none

# Health checks disabled for faster test startup
quarkus.datasource.health.enabled=false

# Test data via migrations (not seed data)
# V219 provides test customers

# Security configuration for tests
# Disable RLS interceptor to avoid RequestContext issues in tests
security.rls.interceptor.enabled=false
# Set fail-closed to false for tests to avoid blocking
security.rls.fail-closed=false

# DISABLE ALL SECURITY FOR TESTS
%test.quarkus.oidc.enabled=false
%test.quarkus.oidc.tenant-enabled=false
%test.quarkus.http.auth.proactive=false
%test.quarkus.security.jaxrs.deny-unannotated-endpoints=false
%test.quarkus.http.auth.permission.permit1.paths=/*
%test.quarkus.http.auth.permission.permit1.policy=permit

# Logging
quarkus.log.level=INFO
quarkus.log.category."de.freshplan".level=INFO
quarkus.log.category."org.flywaydb".level=INFO
quarkus.log.category."org.testcontainers".level=WARN

# Disable validation for tests
%test.quarkus.hibernate-validator.fail-fast=false
%test.freshplan.audit.validation.enabled=false
%test.freshplan.audit.strict-mode=false

# RLS disabled in tests
freshplan.security.rls.enabled=false
%test.freshplan.security.rls.enabled=false

# System user for tests
%test.security.rls.system-user=test-system@freshplan.de

# Allow unauthenticated publishers in tests
%test.freshplan.security.allow-unauthenticated-publisher=true

# Select test alternative for PgNotifySender
%test.quarkus.arc.selected-alternatives=de.freshplan.infrastructure.pg.TestPgNotifySender

# Test performance settings
quarkus.test.continuous-testing=disabled
quarkus.test.native-image-profile=test