# CI Profile - Stabile Konfiguration für GitHub Actions
# Nutzt GitHub Services PostgreSQL, keine Testcontainers

# DevServices komplett deaktivieren
quarkus.devservices.enabled=false

# Datasource - fest konfiguriert für CI
quarkus.datasource.devservices.enabled=false
quarkus.datasource.db-kind=postgresql
quarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5432/freshplan
quarkus.datasource.username=freshplan
quarkus.datasource.password=freshplan

# Connection pool settings for CI stability
quarkus.datasource.jdbc.min-size=2
quarkus.datasource.jdbc.max-size=5
quarkus.datasource.jdbc.acquisition-timeout=60
quarkus.datasource.jdbc.leak-detection-interval=60
quarkus.datasource.jdbc.idle-removal-interval=300
quarkus.datasource.jdbc.max-lifetime=600
quarkus.datasource.jdbc.validation-query-sql=SELECT 1
# Aggressive validation to detect broken connections early
quarkus.datasource.jdbc.background-validation-interval=30
quarkus.datasource.jdbc.validate-on-borrow=true
# Keep connections alive
quarkus.datasource.jdbc.new-connection-sql=SELECT 1

# Flyway - Clean + Migration für sauberen Start
quarkus.flyway.migrate-at-start=true
quarkus.flyway.baseline-on-migrate=true
# CRITICAL: Clean MUSS aktiviert sein für konsistente Tests
quarkus.flyway.clean-disabled=false
quarkus.flyway.clean-at-start=true
# Out-of-order MUSS aktiv sein für CI-Migrationen
quarkus.flyway.out-of-order=true
quarkus.flyway.repair-at-start=false
# Nur noch Standard-Migrationen - keine SEED-Daten mehr
quarkus.flyway.locations=classpath:db/migration
# Explicit schema setting
quarkus.flyway.schemas=public

# Hibernate - nur validieren, keine Schema-Generierung
quarkus.hibernate-orm.database.generation=none
# Zeitzone fix, damit Partitionen deterministisch matchen
quarkus.hibernate-orm.jdbc.timezone=UTC

# Security - komplett deaktiviert für Tests
quarkus.oidc.enabled=false
quarkus.oidc.tenant-enabled=false
quarkus.http.auth.proactive=false
quarkus.security.jaxrs.deny-unannotated-endpoints=false
# Explizit ALLE Pfade erlauben - mehrere Varianten für Sicherheit
quarkus.http.auth.policy.default=permit
quarkus.http.auth.permission.any.paths=/*
quarkus.http.auth.permission.any.policy=permit
quarkus.http.auth.permission.permit-all.paths=/*
quarkus.http.auth.permission.permit-all.policy=permit

# Logging - schlank für CI aber SQL/Flyway verbose für Debugging
quarkus.log.level=INFO
quarkus.log.category."io.quarkus".level=INFO
quarkus.log.category."de.freshplan".level=DEBUG
quarkus.log.category."org.testcontainers".level=ERROR
# Flyway callback debugging
quarkus.log.category."org.flywaydb".level=DEBUG
quarkus.log.category."org.flywaydb.core.internal.callback".level=DEBUG

# SQL Debug Logging - CRITICAL für Test-Debugging
quarkus.hibernate-orm.log.sql=true
quarkus.hibernate-orm.log.bind-parameters=true
quarkus.log.category."org.hibernate.SQL".level=DEBUG
quarkus.log.category."org.hibernate.type.descriptor.sql.BasicBinder".level=TRACE
quarkus.log.category."io.quarkus.agroal".level=DEBUG
quarkus.log.category."io.agroal.pool".level=DEBUG

# Test-Timeouts
quarkus.test.timeout=300s

# CQRS Feature Flags - Conservative defaults
features.cqrs.enabled=false
features.cqrs.customers.list.enabled=false
features.cqrs.customers.search.enabled=false
features.cqrs.opportunities.enabled=false
features.cqrs.salesCockpit.enabled=false
features.cqrs.shadow.enabled=false
features.cqrs.shadow.sampling=0.0

# Event Listener komplett deaktivieren (verhindert Socket-Fehler)
freshplan.events.listener.enabled=false
freshplan.modules.leads.events.enabled=false
# Explizit auch CrossModuleEventListener deaktivieren
freshplan.modules.cross.events.enabled=false
# Disable event propagation completely
quarkus.arc.remove-unused-beans=false

# Security Context Filter disabled for tests
app.security.context-filter.enabled=false

# Lead Module Configuration for Tests
freshplan.followup.enabled=true
freshplan.lead.auto-enrich=false
freshplan.lead.duplicate-check=true